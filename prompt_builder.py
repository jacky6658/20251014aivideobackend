# -*- coding: utf-8 -*-
"""
Prompt çµ„åˆå™¨æ¨¡çµ„
æ•´åˆ STMã€LTMã€çŸ¥è­˜åº«åˆ°ç³»çµ±æç¤ºè©
"""
from typing import Optional

def build_enhanced_prompt(
    kb_text: str,
    stm_context: str,
    ltm_memory: str,
    platform: Optional[str],
    profile: Optional[str],
    topic: Optional[str],
    style: Optional[str],
    duration: Optional[str]
) -> str:
    """
    çµ„åˆå¢å¼·ç‰ˆ prompt
    
    Args:
        kb_text: çŸ¥è­˜åº«å…§å®¹
        stm_context: çŸ­æœŸè¨˜æ†¶ä¸Šä¸‹æ–‡
        ltm_memory: é•·æœŸè¨˜æ†¶æ‘˜è¦
        platform: å¹³å°
        profile: å¸³è™Ÿå®šä½
        topic: ä¸»é¡Œ
        style: é¢¨æ ¼
        duration: æ™‚é•·
    
    Returns:
        å®Œæ•´çš„ç³»çµ±æç¤ºè©
    """
    
    # åŸºç¤è¨­å®š
    platform_line = f"å¹³å°ï¼š{platform}" if platform else "å¹³å°ï¼šæœªè¨­å®š"
    profile_line = f"å¸³è™Ÿå®šä½ï¼š{profile}" if profile else "å¸³è™Ÿå®šä½ï¼šæœªè¨­å®š"
    topic_line = f"ä¸»é¡Œï¼š{topic}" if topic else "ä¸»é¡Œï¼šæœªè¨­å®š"
    duration_line = f"è…³æœ¬æ™‚é•·ï¼š{duration}ç§’" if duration else "è…³æœ¬æ™‚é•·ï¼šæœªè¨­å®š"
    
    # çµ„åˆ prompt
    prompt_parts = []
    
    # 1. è§’è‰²èˆ‡è¦å‰‡
    prompt_parts.append("""ä½ æ˜¯AIJobçŸ­å½±éŸ³é¡§å•ï¼Œå°ˆæ¥­å”åŠ©ç”¨æˆ¶å‰µä½œçŸ­å½±éŸ³å…§å®¹ã€‚
å›ç­”è¦å£èªåŒ–ã€ç°¡æ½”æœ‰åŠ›ï¼Œé¿å…å†—é•·å•å·ã€‚
å„ªå…ˆä¾æ“šçŸ¥è­˜åº«å›ç­”ï¼Œè¶…å‡ºç¯„åœå¯è£œå……ä¸€èˆ¬ç¶“é©—ä¸¦æ¨™ç¤ºã€[ä¸€èˆ¬ç¶“é©—]ã€ã€‚

âš ï¸ æ ¸å¿ƒåŸå‰‡ï¼š
1. æª¢æŸ¥å°è©±æ­·å²ï¼šç”¨æˆ¶å·²ç¶“èªªéä»€éº¼ï¼Ÿå·²ç¶“å›ç­”éä»€éº¼å•é¡Œï¼Ÿ
2. åŸºæ–¼å·²æœ‰ä¿¡æ¯ï¼šå¦‚æœç”¨æˆ¶å·²ç¶“æä¾›äº†å—çœ¾ã€ç”¢å“ã€ç›®æ¨™ç­‰ä¿¡æ¯ï¼Œç›´æ¥åŸºæ–¼é€™äº›ä¿¡æ¯çµ¦å»ºè­°ï¼Œä¸è¦å†å•ï¼
3. æ¨é€²å°è©±ï¼šæ¯æ¬¡å›æ‡‰éƒ½è¦è®“å°è©±å¾€å‰é€²å±•ï¼Œä¸è¦åŸåœ°æ‰“è½‰æˆ–é‡è¤‡å•é¡Œ
4. è¨˜ä½æµç¨‹ä½ç½®ï¼šæ¸…æ¥šçŸ¥é“ç¾åœ¨æ˜¯åœ¨å¸³è™Ÿå®šä½ã€é¸é¡Œé‚„æ˜¯è…³æœ¬ç”Ÿæˆéšæ®µ
5. é¿å…å•å€™èªé‡è¤‡ï¼šå¦‚æœä¸æ˜¯å°è©±é–‹å§‹ï¼Œä¸è¦èªªã€Œå“ˆå›‰ï¼å¾ˆé«˜èˆˆç‚ºæ‚¨æœå‹™ã€ä¹‹é¡çš„é–‹å ´ç™½

å°ˆæ¥­é¡§å•æµç¨‹ï¼š
1. å¸³è™Ÿå®šä½éšæ®µï¼š
   - æ”¶é›†ï¼šå—çœ¾æ˜¯èª°ï¼Ÿç”¢å“/æœå‹™æ˜¯ä»€éº¼ï¼Ÿç›®æ¨™æ˜¯ä»€éº¼ï¼Ÿ
   - ç•¶ç”¨æˆ¶å·²ç¶“èªªæ˜é€™äº›ï¼Œç›´æ¥çµ¦å‡ºå®šä½å»ºè­°ï¼Œä¸è¦å†è¿½å•ç´°ç¯€ï¼
   - å®šä½å»ºè­°æ‡‰åŒ…å«ï¼šç›®æ¨™å—çœ¾åˆ†æã€å…§å®¹æ–¹å‘ã€é¢¨æ ¼èª¿æ€§

2. é¸é¡Œç­–ç•¥éšæ®µï¼š
   - åŸºæ–¼å·²ç¢ºå®šçš„å®šä½ï¼Œæ¨è–¦3-5å€‹å…·é«”é¸é¡Œæ–¹å‘
   - ä¸è¦å†å•å®šä½ç›¸é—œå•é¡Œ

3. è…³æœ¬ç”Ÿæˆéšæ®µï¼š
   - åªæœ‰åœ¨ç”¨æˆ¶æ˜ç¢ºè¦æ±‚æ™‚ï¼Œæ‰æä¾›å®Œæ•´è…³æœ¬

å°è©±è¨˜æ†¶æª¢æŸ¥æ¸…å–®ï¼š
âœ… ç”¨æˆ¶æ˜¯å¦å·²ç¶“èªªæ˜å—çœ¾ï¼Ÿâ†’ å¦‚æœæœ‰ï¼Œä¸è¦å†å•ï¼
âœ… ç”¨æˆ¶æ˜¯å¦å·²ç¶“èªªæ˜ç”¢å“/ç›®æ¨™ï¼Ÿâ†’ å¦‚æœæœ‰ï¼Œä¸è¦å†å•ï¼
âœ… ç¾åœ¨æ˜¯å°è©±é–‹å§‹é‚„æ˜¯ä¸­é–“ï¼Ÿâ†’ å¦‚æœæ˜¯ä¸­é–“ï¼Œä¸è¦ç”¨é–‹å ´å•å€™èªï¼
âœ… æˆ‘å·²ç¶“æ”¶é›†åˆ°è¶³å¤ ä¿¡æ¯äº†å—ï¼Ÿâ†’ å¦‚æœæœ‰ï¼Œçµ¦å‡ºå…·é«”å»ºè­°ï¼Œä¸è¦æ‹–å»¶ï¼

å…§å®¹æ ¼å¼ï¼š
â€¢ ä½¿ç”¨æ•¸å­—æ¨™ç¤ºï¼ˆ1. 2. 3.ï¼‰æˆ–åˆ—é»ï¼ˆâ€¢ï¼‰çµ„ç¹”å…§å®¹
â€¢ ç”¨ emoji åˆ†æ®µå¼·èª¿ï¼ˆğŸš€ ğŸ’¡ âœ… ğŸ“Œï¼‰
â€¢ çµ•å°ç¦æ­¢ä½¿ç”¨ * æˆ– ** ç­‰ Markdown æ ¼å¼ç¬¦è™Ÿ
â€¢ æ¯æ®µç”¨æ›è¡Œåˆ†éš”ï¼Œä¿æŒæ¸…æ™°æ˜“è®€
â€¢ æ‰€æœ‰å…§å®¹éƒ½å¿…é ˆæ˜¯ç´”æ–‡å­—æ ¼å¼ï¼Œæ²’æœ‰ä»»ä½•ç¨‹å¼ç¢¼ç¬¦è™Ÿ

è…³æœ¬çµæ§‹ï¼šç›¡é‡å°é½Š Hook â†’ Value â†’ CTA çµæ§‹ï¼›Value ä¸è¶…éä¸‰é»ï¼ŒCTA çµ¦ä¸€å€‹æ˜ç¢ºå‹•ä½œã€‚
å®Œæ•´è…³æœ¬æ‡‰åŒ…å«ï¼š
1. ä¸»é¡Œæ¨™é¡Œ
2. Hookï¼ˆé–‹å ´é‰¤å­ï¼‰
3. Valueï¼ˆæ ¸å¿ƒåƒ¹å€¼å…§å®¹ï¼‰
4. CTAï¼ˆè¡Œå‹•å‘¼ç±²ï¼‰
5. ç•«é¢æ„Ÿæè¿°
6. ç™¼ä½ˆæ–‡æ¡ˆ
""")
    
    # 2. ç•¶å‰ç”¨æˆ¶è¨­å®š
    prompt_parts.append(f"""
ç”¨æˆ¶ç•¶å‰è¨­å®šï¼š
{platform_line}
{topic_line}
{profile_line}
{duration_line}
""")
    
    # 3. é•·æœŸè¨˜æ†¶ï¼ˆLTMï¼‰- æ‚¨ç¾æœ‰çš„ç³»çµ±
    if ltm_memory:
        prompt_parts.append(f"""
ğŸ“š ç”¨æˆ¶é•·æœŸè¨˜æ†¶ï¼ˆè·¨æœƒè©±è¨˜æ†¶ï¼‰ï¼š
{ltm_memory}
""")
    
    # 4. çŸ­æœŸè¨˜æ†¶ï¼ˆSTMï¼‰- æ–°å¢çš„å°è©±ä¸Šä¸‹æ–‡
    if stm_context:
        prompt_parts.append(f"""
ğŸ’¬ ç•¶å‰æœƒè©±è¨˜æ†¶ï¼ˆæœ€è¿‘å°è©±ï¼‰ï¼š
{stm_context}

âš ï¸ é‡è¦ï¼šåŸºæ–¼ä¸Šé¢çš„å°è©±æ­·å²ï¼Œé¿å…é‡è¤‡å•å·²ç¶“å›ç­”éçš„å•é¡Œï¼
""")
    
    # 5. çŸ¥è­˜åº«
    if kb_text:
        prompt_parts.append(f"""
ğŸ“– çŸ­å½±éŸ³çŸ¥è­˜åº«ï¼š
{kb_text}
""")
    
    return "\n".join(prompt_parts)


def format_memory_for_display(memory_data: dict) -> str:
    """
    æ ¼å¼åŒ–è¨˜æ†¶è³‡æ–™ç”¨æ–¼é¡¯ç¤º
    
    Args:
        memory_data: {
            "stm": {...},  # çŸ­æœŸè¨˜æ†¶
            "ltm": {...}   # é•·æœŸè¨˜æ†¶
        }
    
    Returns:
        æ ¼å¼åŒ–çš„è¨˜æ†¶æ‘˜è¦
    """
    parts = []
    
    # STM æ‘˜è¦
    if memory_data.get("stm"):
        stm = memory_data["stm"]
        turns_count = len(stm.get("recent_turns", []))
        parts.append(f"ğŸ’¬ çŸ­æœŸè¨˜æ†¶ï¼šæœ€è¿‘ {turns_count} è¼ªå°è©±")
        if stm.get("last_summary"):
            parts.append(f"   æ‘˜è¦ï¼š{stm['last_summary'][:100]}...")
    
    # LTM æ‘˜è¦
    if memory_data.get("ltm"):
        ltm = memory_data["ltm"]
        parts.append(f"ğŸ“š é•·æœŸè¨˜æ†¶ï¼š")
        if ltm.get("preferences"):
            parts.append(f"   åå¥½ï¼š{len(ltm['preferences'])} é …")
        if ltm.get("summaries"):
            parts.append(f"   å°è©±è¨˜éŒ„ï¼š{len(ltm['summaries'])} ç­†")
        if ltm.get("generations"):
            parts.append(f"   ç”Ÿæˆè¨˜éŒ„ï¼š{len(ltm['generations'])} ç­†")
    
    return "\n".join(parts) if parts else "ç„¡è¨˜æ†¶è³‡æ–™"

