# AI çŸ­å½±éŸ³æ™ºèƒ½é«” - å¾Œç«¯æœå‹™

## ğŸ“Œ å°ˆæ¡ˆæ•´åˆå ±å‘Šï¼ˆå¾Œç«¯ ReelMindbackendï¼‰

### ä¸€ã€å°ˆæ¡ˆç¸½è¦½ï¼ˆè§’è‰²èˆ‡è³‡æ–™æµï¼‰
- **è§’è‰²å®šä½**ï¼šFastAPI æ ¸å¿ƒæœå‹™ï¼Œæ‰¿è¼‰ OAuthã€èŠå¤©/ç”Ÿæˆï¼ˆå« SSEï¼‰ã€è³‡æ–™æŒä¹…åŒ–ï¼ˆSQLite/PostgreSQLï¼‰ã€ç®¡ç†ç«¯ APIã€è¨‚å–®/æˆæ¬Š APIã€‚
- **è³‡æ–™æµ**ï¼š
  - å‰ç«¯å‘¼å« `/api/auth/*` å®Œæˆç™»å…¥ï¼›è‡ªå‹•è¨»å†Š `user_auth`
  - `/api/chat/stream` ä¸²æµå›è¦†ä¸¦å¯«å…¥ `conversation_summaries`
  - `/api/scripts/*` èˆ‡ `generations`ã€`user_scripts`ã€`positioning_records` ç­‰è¡¨äº’å‹•
  - å¸³å–®èˆ‡æˆæ¬Šï¼š`/api/user/orders/{id}`ã€`/api/user/license/{id}`ã€`/api/admin/orders`

### äºŒã€ç›®å‰æ“æœ‰åŠŸèƒ½ï¼ˆé‡é»ï¼‰
- âœ… PostgreSQL/SQLite é›™æ£§è‡ªå‹•åˆ‡æ›ã€æ–¹è¨€ç›¸å®¹ï¼ˆæ—¥æœŸ/ä½”ä½ç¬¦/UPSERTï¼‰
- âœ… ç®¡ç†ç«¯ APIï¼šæ¨¡å¼çµ±è¨ˆã€å°è©±/è…³æœ¬æ¸…å–®ã€åˆ†æã€CSV åŒ¯å‡º
- âœ… å¸³å–®/æˆæ¬Šè¡¨èˆ‡ APIï¼š`orders`ã€`licenses`ï¼ˆæŸ¥è©¢å·²ä¸Šç·šï¼‰
- âœ… OAuth ä¿®å¾©ï¼š`ON CONFLICT` èˆ‡ `expires_at` é¡å‹è™•ç†

### ä¸‰ã€ç³»çµ±æ¶æ§‹èˆ‡è³‡æ–™æµï¼ˆç°¡ï¼‰
- å¾Œç«¯ï¼ˆæœ¬å°ˆæ¡ˆï¼‰â†â†’ PostgreSQLï¼ˆZeaburï¼‰
- æä¾›å‰ç«¯èˆ‡å¾Œå°ç®¡ç†å…©ç«¯ä½¿ç”¨ä¹‹çµ±ä¸€ API

### å››ã€å°šæœªè§£æ±º/å¾…è¾¦ï¼ˆBackï¼‰
- â³ é‡‘æµæ•´åˆï¼ˆECPay/åºè™Ÿï¼‰ï¼šæ–°å¢ `/api/payment/*`ã€é©—ç°½ã€å›å‚³ã€è½å–®ã€é–‹ç«‹ç™¼ç¥¨æ¬„ä½
- â³ Admin æ¬Šé™å¼·åŒ–ï¼šåŠ å…¥ç®¡ç†å“¡ JWT/ç™½åå–®ã€é€Ÿç‡é™åˆ¶
- â³ è¨‚å–® CSV åŒ¯å‡ºç«¯é» `/api/admin/export/orders`

### äº”ã€å·²è§£æ±ºé‡é»ï¼ˆBackï¼‰
- âœ… `INSERT OR REPLACE` â†’ PostgreSQL `ON CONFLICT ... DO UPDATE`
- âœ… `expires_at` é¡å‹ä¿®å¾©ï¼ˆtimestamp vs numericï¼‰
- âœ… æ—¥æœŸå‡½å¼ç›¸å®¹ï¼ˆ`datetime('now')` â†’ `CURRENT_TIMESTAMP` / `INTERVAL`ï¼‰
- âœ… åŠ å…¥ `orders`ã€`licenses` è¡¨ï¼Œä¸¦æä¾›æŸ¥è©¢ API
- âœ… 500 éŒ¯èª¤ä¿®å¾©ï¼šè£œé½Š `conversation_summaries` è¡¨ç¼ºå°‘æ¬„ä½ï¼ˆ`message_count`ã€`updated_at`ï¼‰
- âœ… CORS è¨­å®šï¼šåŠ å…¥å‰ç«¯è‡ªè¨‚ç¶²åŸŸ `reelmind.aijob.com.tw` å’Œå¾Œå° `backmanage.zeabur.app`
- âœ… `create_app()` å‡½æ•¸ä¿®æ­£ï¼šç¢ºä¿è¿”å› `app` å¯¦ä¾‹
- âœ… PostgreSQL/SQLite SQL èªæ³•å·®ç•°ä¿®æ­£ï¼šæ‰€æœ‰ API ç«¯é»éƒ½æ”¯æ´é›™è³‡æ–™åº«
- âœ… **é•·æœŸè¨˜æ†¶ç³»çµ±**ï¼šæ–°å¢ `long_term_memory`ã€`ai_advisor_chats`ã€`ip_planning_chats`ã€`llm_conversations` è³‡æ–™è¡¨
- âœ… **æœƒè©±ç®¡ç†API**ï¼šæ–°å¢ `/api/memory/long-term`ã€`/api/memory/sessions` ç«¯é»
- âœ… **ç®¡ç†å“¡é•·æœŸè¨˜æ†¶API**ï¼šæ–°å¢ `/api/admin/long-term-memory`ã€`/api/admin/memory-stats` ç«¯é»

---
ï¼ˆä»¥ä¸‹ç‚ºåŸ README å…§å®¹ï¼‰

## âš ï¸ é‡è¦å•é¡Œ - å„ªå…ˆè§£æ±º

### ğŸš¨ è…³æœ¬å„²å­˜ç³»çµ±å•é¡Œ

**ç¾è±¡**ï¼šè…³æœ¬å„²å­˜åŠŸèƒ½ç„¡æ³•æ­£å¸¸å·¥ä½œï¼Œå‡ºç¾ 401 Unauthorized éŒ¯èª¤

#### å•é¡Œåˆ†æ

1. **APIèªè­‰å•é¡Œ**ï¼š
   - è…³æœ¬ç›¸é—œAPIéœ€è¦ç”¨æˆ¶èªè­‰
   - å‰ç«¯èªè­‰tokenå¯èƒ½éæœŸæˆ–ç„¡æ•ˆ
   - éœ€è¦æª¢æŸ¥ `get_current_user` å‡½æ•¸çš„å¯¦ç¾

2. **è³‡æ–™åº«é–å®šå•é¡Œ**ï¼š
   - å¶çˆ¾å‡ºç¾ `database is locked` éŒ¯èª¤
   - å¤šå€‹è«‹æ±‚åŒæ™‚è¨ªå•SQLiteè³‡æ–™åº«
   - éœ€è¦å„ªåŒ–è³‡æ–™åº«é€£æ¥ç®¡ç†

3. **å½±éŸ¿ç¯„åœ**ï¼š
   - âŒ è…³æœ¬å„²å­˜åŠŸèƒ½
   - âŒ è…³æœ¬è¼‰å…¥åŠŸèƒ½
   - âŒ è…³æœ¬ç®¡ç†åŠŸèƒ½ï¼ˆé‡å‘½åã€åˆªé™¤ï¼‰

### ğŸš¨ ç”¨æˆ¶è³‡æ–™æŒä¹…åŒ–å•é¡Œ

**ç¾è±¡**ï¼šç”¨æˆ¶åæ˜ ã€Œé‡æ–°åˆ·æ–°ç™»å…¥å¾Œå¸³è™Ÿå®šä½ä¸è¦‹äº†ã€

#### åŸå› åˆ†æ

1. **æœ¬åœ°è³‡æ–™åº« vs Zeabur è³‡æ–™åº«**ï¼š
   - æœ¬åœ°é–‹ç™¼æ™‚ï¼Œè³‡æ–™å„²å­˜åœ¨æœ¬æ©Ÿçš„ `backend/data/chatbot.db`
   - Zeabur éƒ¨ç½²æ™‚ï¼Œè³‡æ–™å„²å­˜åœ¨ Zeabur ä¼ºæœå™¨çš„è³‡æ–™åº«
   - é€™å…©å€‹è³‡æ–™åº«æ˜¯**å®Œå…¨ç¨ç«‹**çš„
   - **å•é¡Œ**ï¼šæœ¬åœ°å‰µå»ºçš„è³‡æ–™ä¸æœƒåŒæ­¥åˆ° Zeabur

2. **SQLite çš„é™åˆ¶**ï¼š
   - Zeabur é‡æ–°éƒ¨ç½²æ™‚ï¼ŒSQLite è³‡æ–™åº«æœƒè¢«**é‡ç½®**
   - æ‰€æœ‰ç”¨æˆ¶è³‡æ–™ï¼ˆå¸³è™Ÿå®šä½è¨˜éŒ„ã€å°è©±æ­·å²ã€ç”Ÿæˆè¨˜éŒ„ï¼‰æœƒ**éºå¤±**
   - **ä¸é©åˆç”Ÿç”¢ç’°å¢ƒé•·æœŸä½¿ç”¨**

3. **å½±éŸ¿ç¯„åœ**ï¼š
   - âŒ ç”¨æˆ¶çš„å¸³è™Ÿå®šä½è¨˜éŒ„
   - âŒ å°è©±æ­·å²
   - âŒ ç”Ÿæˆçš„è…³æœ¬è¨˜éŒ„
   - âŒ ç”¨æˆ¶åå¥½è¨­å®š
   - âŒ é•·æœŸè¨˜æ†¶æ•¸æ“š

#### è§£æ±ºæ–¹æ¡ˆ

##### ğŸ”´ çŸ­æœŸæ–¹æ¡ˆï¼ˆç›®å‰ä½¿ç”¨ä¸­ï¼‰

**é™åˆ¶**ï¼š
- åœ¨ Zeabur ä¸Šé‡æ–°å‰µå»ºçš„è¨˜éŒ„æœƒä¿å­˜ï¼Œä½†åªåˆ°ä¸‹æ¬¡é‡æ–°éƒ¨ç½²ç‚ºæ­¢
- æ¯æ¬¡é‡æ–°éƒ¨ç½²éƒ½æœƒéºå¤±æ‰€æœ‰ç”¨æˆ¶è³‡æ–™
- **åƒ…é©ç”¨æ–¼æ¸¬è©¦å’Œé–‹ç™¼éšæ®µ**

**æ³¨æ„äº‹é …**ï¼š
```python
# ç›®å‰çš„è³‡æ–™åº«åˆå§‹åŒ–æ–¹å¼ï¼ˆæœ‰è³‡æ–™éºå¤±é¢¨éšªï¼‰
DB_PATH = os.path.join(os.path.dirname(__file__), "data", "chatbot.db")
conn = sqlite3.connect(DB_PATH)  # Zeabur é‡æ–°éƒ¨ç½²æ™‚æœƒé‡ç½®
```

##### ğŸŸ¢ é•·æœŸæ–¹æ¡ˆï¼ˆå¼·çƒˆå»ºè­°ï¼‰

**1. ä½¿ç”¨æŒä¹…åŒ–è³‡æ–™åº«æœå‹™**

æ¨è–¦é¸é …ï¼š
- **PostgreSQL**ï¼ˆZeabur åŸç”Ÿæ”¯æ´ï¼Œæ¨è–¦ï¼‰
- **MySQL**ï¼ˆZeabur åŸç”Ÿæ”¯æ´ï¼‰
- **MongoDB**ï¼ˆé©åˆæ–‡æª”å‹è³‡æ–™ï¼‰

**Zeabur PostgreSQL æ•´åˆæ­¥é©Ÿ**ï¼š
```bash
# 1. åœ¨ Zeabur å°ˆæ¡ˆä¸­æ·»åŠ  PostgreSQL æœå‹™
# 2. Zeabur æœƒè‡ªå‹•æä¾›é€£ç·šè³‡è¨Šï¼š
#    DATABASE_URL=postgresql://user:password@host:port/dbname

# 3. æ›´æ–° requirements.txt
pip install psycopg2-binary  # PostgreSQL é©…å‹•
pip install sqlalchemy       # ORMï¼ˆå¯é¸ï¼‰

# 4. ä¿®æ”¹ app.py é€£æ¥é‚è¼¯
import os
import psycopg2
from urllib.parse import urlparse

DATABASE_URL = os.getenv("DATABASE_URL")
if DATABASE_URL:
    # ä½¿ç”¨ PostgreSQL
    url = urlparse(DATABASE_URL)
    conn = psycopg2.connect(
        host=url.hostname,
        port=url.port,
        user=url.username,
        password=url.password,
        database=url.path[1:]
    )
else:
    # æœ¬åœ°é–‹ç™¼ä½¿ç”¨ SQLite
    conn = sqlite3.connect("data/chatbot.db")
```

**2. è³‡æ–™åº«é·ç§»è¨ˆåŠƒ**

**éšæ®µ 1ï¼šæº–å‚™å·¥ä½œ**
- [ ] åœ¨ Zeabur æ·»åŠ  PostgreSQL æœå‹™
- [ ] å–å¾—é€£ç·š URL
- [ ] å®‰è£å¿…è¦çš„ Python å¥—ä»¶

**éšæ®µ 2ï¼šç¨‹å¼ç¢¼ä¿®æ”¹**
- [ ] ä¿®æ”¹ `init_database()` å‡½æ•¸æ”¯æ´ PostgreSQL
- [ ] æ›´æ–° SQL èªæ³•ï¼ˆSQLite â†’ PostgreSQLï¼‰
- [ ] è™•ç†è³‡æ–™é¡å‹å·®ç•°ï¼ˆä¾‹å¦‚ï¼š`AUTOINCREMENT` â†’ `SERIAL`ï¼‰
- [ ] æ¸¬è©¦æ‰€æœ‰ API ç«¯é»

**éšæ®µ 3ï¼šè³‡æ–™é·ç§»**
- [ ] å‚™ä»½ç¾æœ‰ SQLite è³‡æ–™
- [ ] ç·¨å¯«é·ç§»è…³æœ¬
- [ ] å°‡è³‡æ–™åŒ¯å…¥ PostgreSQL
- [ ] é©—è­‰è³‡æ–™å®Œæ•´æ€§

**éšæ®µ 4ï¼šéƒ¨ç½²**
- [ ] æ›´æ–° Zeabur ç’°å¢ƒè®Šæ•¸
- [ ] é‡æ–°éƒ¨ç½²å¾Œç«¯æœå‹™
- [ ] å®Œæ•´æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½
- [ ] ç›£æ§è³‡æ–™æŒä¹…åŒ–ç‹€æ…‹

**3. SQLite vs PostgreSQL èªæ³•å·®ç•°**

| åŠŸèƒ½ | SQLite | PostgreSQL |
|------|--------|------------|
| è‡ªå‹•éå¢ | `AUTOINCREMENT` | `SERIAL` æˆ– `BIGSERIAL` |
| å¸ƒæ—å€¼ | `INTEGER` (0/1) | `BOOLEAN` |
| æ—¥æœŸæ™‚é–“ | `TEXT` æˆ– `INTEGER` | `TIMESTAMP` |
| JSON | `TEXT` | `JSON` æˆ– `JSONB` |
| å…¨æ–‡æœç´¢ | æœ‰é™ | å¼·å¤§çš„ `tsvector` |

**4. é ä¼°å·¥ä½œé‡**

- **ç¨‹å¼ç¢¼ä¿®æ”¹**ï¼š2-3 å°æ™‚
- **æ¸¬è©¦é©—è­‰**ï¼š1-2 å°æ™‚
- **è³‡æ–™é·ç§»**ï¼š1 å°æ™‚
- **ç¸½è¨ˆ**ï¼š4-6 å°æ™‚

#### è‡¨æ™‚ç·©è§£æªæ–½

åœ¨å®Œæˆè³‡æ–™åº«é·ç§»ä¹‹å‰ï¼Œå¯æ¡å–ä»¥ä¸‹æªæ–½ï¼š

1. **å®šæœŸå‚™ä»½**ï¼š
   ```bash
   # åœ¨ Zeabur é‡æ–°éƒ¨ç½²å‰å‚™ä»½è³‡æ–™åº«
   # ä½¿ç”¨ db_admin.py å·¥å…·
   python db_admin.py backup
   ```

2. **é™ä½é‡æ–°éƒ¨ç½²é »ç‡**ï¼š
   - åœ¨æœ¬åœ°å……åˆ†æ¸¬è©¦å¾Œå†æ¨é€
   - ä½¿ç”¨ Git åˆ†æ”¯é€²è¡Œé–‹ç™¼
   - æ¸›å°‘ä¸å¿…è¦çš„éƒ¨ç½²

3. **ç”¨æˆ¶æºé€š**ï¼š
   - åœ¨å‰ç«¯é¡¯ç¤ºæç¤ºï¼šã€Œæ¸¬è©¦éšæ®µï¼Œè³‡æ–™å¯èƒ½æœƒé‡ç½®ã€
   - æä¾›åŒ¯å‡ºåŠŸèƒ½ï¼ˆæœªä¾†ï¼‰

#### å¯¦æ–½å„ªå…ˆç´š

ğŸ”´ **P0 - ç·Šæ€¥ï¼ˆ1 é€±å…§ï¼‰**ï¼š
- [ ] è©•ä¼°ä¸¦é¸æ“‡æŒä¹…åŒ–è³‡æ–™åº«æ–¹æ¡ˆ
- [ ] åˆ¶å®šè©³ç´°çš„é·ç§»è¨ˆåŠƒ

ğŸŸ¡ **P1 - é«˜å„ªå…ˆç´šï¼ˆ2 é€±å…§ï¼‰**ï¼š
- [ ] å®Œæˆ PostgreSQL æ•´åˆ
- [ ] è³‡æ–™åº«é·ç§»è…³æœ¬é–‹ç™¼
- [ ] å®Œæ•´æ¸¬è©¦

ğŸŸ¢ **P2 - ä¸­å„ªå…ˆç´šï¼ˆ1 å€‹æœˆå…§ï¼‰**ï¼š
- [ ] å¯¦æ–½è‡ªå‹•å‚™ä»½æ©Ÿåˆ¶
- [ ] æ·»åŠ è³‡æ–™åŒ¯å‡ºåŠŸèƒ½
- [ ] å„ªåŒ–æŸ¥è©¢æ•ˆèƒ½

---

## å°ˆæ¡ˆç°¡ä»‹
AI çŸ­å½±éŸ³æ™ºèƒ½é«”å¾Œç«¯æœå‹™ï¼Œæä¾›çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆå’Œæ–‡æ¡ˆå‰µä½œåŠŸèƒ½ã€‚

## æŠ€è¡“æ£§
- **æ¡†æ¶**: FastAPI
- **AI æ¨¡å‹**: Google Gemini 2.5 Flash
- **èªè¨€**: Python 3.11
- **éƒ¨ç½²**: Zeabur

## åŠŸèƒ½ç‰¹è‰²
- çŸ­å½±éŸ³è…³æœ¬ç”Ÿæˆ
- æ™ºèƒ½æ–‡æ¡ˆå‰µä½œ
- æ”¯æ´å¤šå¹³å°æ ¼å¼ï¼ˆIG Reelsã€TikTokã€å°ç´…æ›¸ï¼‰
- è‡ªå®šç¾©è…³æœ¬æ™‚é•·ï¼ˆ30/60/90ç§’ï¼‰
- çŸ¥è­˜åº«æ•´åˆ

## ç’°å¢ƒè®Šæ•¸è¨­å®š
```bash
# AI æ¨¡å‹è¨­å®š
GEMINI_API_KEY=your_gemini_api_key
GEMINI_MODEL=gemini-2.5-flash
KB_PATH=/app/data/kb.txt

# OAuth èªè­‰è¨­å®š
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
OAUTH_REDIRECT_URI=https://aivideobackend.zeabur.app/api/auth/google/callback

# JWT è¨­å®šï¼ˆå¿…é ˆæ˜¯å›ºå®šå€¼ï¼‰
JWT_SECRET=u5c1N4kQm8Zf2Tg7Pp9Lr3Xw6Yd0Aq2H

# è³‡æ–™åº«è¨­å®šï¼ˆå¯é¸ï¼‰
DATABASE_URL=postgresql://user:password@host:port/dbname  # å¦‚æœæœ‰ PostgreSQL
DATABASE_PATH=/persistent  # SQLite æŒä¹…åŒ–è·¯å¾‘ï¼ˆZeabur ä½¿ç”¨ï¼‰
```

**é‡è¦æ³¨æ„äº‹é …**ï¼š
- `JWT_SECRET` å¿…é ˆæ˜¯å›ºå®šå€¼ï¼Œå»ºè­°ä½¿ç”¨æä¾›çš„å€¼æˆ–åœ¨ Zeabur ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š
- å¦‚æœ `JWT_SECRET` æ”¹è®Šï¼Œæ‰€æœ‰ç¾æœ‰çš„ access token éƒ½æœƒå¤±æ•ˆ
- `OAUTH_REDIRECT_URI` å¿…é ˆèˆ‡ Google Cloud Console ä¸­è¨­å®šçš„ redirect URI å®Œå…¨ä¸€è‡´

## æœ¬åœ°é–‹ç™¼

### ç¬¬ä¸€æ¬¡è¨­å®šï¼ˆmacOSï¼‰
ç”±æ–¼ macOS ç³»çµ±çš„ Python ç’°å¢ƒä¿è­·æ©Ÿåˆ¶ï¼Œéœ€è¦ä½¿ç”¨è™›æ“¬ç’°å¢ƒï¼š

**å®Œæ•´çš„è¤‡è£½è²¼ä¸ŠæŒ‡ä»¤**ï¼š
```bash
# 1. é€²å…¥å¾Œç«¯ç›®éŒ„
cd /Users/user/Downloads/ai_web_app/å°è©±å¼/chatbot/backend

# 2. å‰µå»ºè™›æ“¬ç’°å¢ƒ
python3 -m venv venv

# 3. å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
source venv/bin/activate

# 4. å®‰è£ä¾è³´å¥—ä»¶
pip install uvicorn fastapi google-generativeai python-dotenv

# 5. è¨­å®š API Keyï¼ˆæ›¿æ›æˆæ‚¨çš„å¯¦éš›é‡‘é‘°ï¼‰
export GEMINI_API_KEY="AIzaSyCNmsgpPxo6acx3TV1VrvMLWOvqqj38TR4"

# 6. å•Ÿå‹•æœå‹™
python -m uvicorn app:app --host 127.0.0.1 --port 8000 --reload
```

### å¿«é€Ÿå•Ÿå‹•è…³æœ¬ï¼ˆæ¨è–¦ï¼‰
ä½¿ç”¨ä¿®å¾©å¾Œçš„ `start.sh` è…³æœ¬ï¼Œæœƒè‡ªå‹•å®‰è£æ‰€æœ‰å¿…è¦çš„å¥—ä»¶ï¼š

```bash
cd /Users/user/Downloads/ai_web_app/å°è©±å¼/chatbot/backend
./start.sh
```

**è…³æœ¬åŠŸèƒ½**ï¼š
- âœ… è‡ªå‹•å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
- âœ… è‡ªå‹•å®‰è£æ‰€æœ‰å¿…è¦çš„å¥—ä»¶ï¼ˆåŒ…æ‹¬ `python-dotenv`ï¼‰
- âœ… è‡ªå‹•è¨­å®š API Key
- âœ… è‡ªå‹•å•Ÿå‹•å¾Œç«¯æœå‹™

**å®Œæ•´çš„è¤‡è£½è²¼ä¸ŠæŒ‡ä»¤**ï¼š
```bash
# 1. é€²å…¥å¾Œç«¯ç›®éŒ„
cd /Users/user/Downloads/ai_web_app/å°è©±å¼/chatbot/backend

# 2. åŸ·è¡Œå•Ÿå‹•è…³æœ¬ï¼ˆæœƒè‡ªå‹•è™•ç†æ‰€æœ‰è¨­å®šï¼‰
./start.sh
```

**é æœŸçµæœ**ï¼š
```
ğŸš€ å•Ÿå‹• AI çŸ­å½±éŸ³æ™ºèƒ½é«”å¾Œç«¯æœå‹™...
ğŸ“¦ å®‰è£å¿…è¦çš„å¥—ä»¶...
Successfully installed python-dotenv-1.1.1
ğŸš€ å•Ÿå‹•å¾Œç«¯æœå‹™...
çŸ¥è­˜åº«è¼‰å…¥ç‹€æ…‹: æˆåŠŸ
çŸ¥è­˜åº«å…§å®¹é•·åº¦: 5945 å­—å…ƒ
INFO: Uvicorn running on http://127.0.0.1:8000
INFO: Application startup complete.
```

### æ‰‹å‹•å•Ÿå‹•ï¼ˆæ¯æ¬¡é–‹ç™¼æ™‚ï¼‰
**å®Œæ•´çš„è¤‡è£½è²¼ä¸ŠæŒ‡ä»¤**ï¼š
```bash
# 1. é€²å…¥å¾Œç«¯ç›®éŒ„
cd /Users/user/Downloads/ai_web_app/å°è©±å¼/chatbot/backend

# 2. å•Ÿå‹•è™›æ“¬ç’°å¢ƒ
source venv/bin/activate

# 3. è¨­å®š API Keyï¼ˆæ›¿æ›æˆæ‚¨çš„å¯¦éš›é‡‘é‘°ï¼‰
export GEMINI_API_KEY="AIzaSyCNmsgpPxo6acx3TV1VrvMLWOvqqj38TR4"

# 4. å•Ÿå‹•æœå‹™
python -m uvicorn app:app --host 127.0.0.1 --port 8000 --reload
```

### æ¸¬è©¦ API
```bash
curl http://localhost:8000/api/health
```

## Docker éƒ¨ç½²

### å»ºæ§‹æ˜ åƒ
```bash
docker build -t ai-video-backend .
```

### é‹è¡Œå®¹å™¨
```bash
docker run -p 8000:8000 -e GEMINI_API_KEY=your_key ai-video-backend
```

## API ç«¯é»

### å¥åº·æª¢æŸ¥
- **GET** `/api/health`
- å›æ‡‰: `{"status": "ok"}`

### èŠå¤©ä¸²æµ
- **POST** `/api/chat/stream`
- è«‹æ±‚æ ¼å¼:
```json
{
  "message": "ç”Ÿæˆè…³æœ¬",
  "platform": "Reels",
  "topic": "ä¸»é¡Œ",
  "duration": "30",
  "profile": "å¸³è™Ÿå®šä½",
  "history": []
}
```

### é•·æœŸè¨˜æ†¶ç³»çµ±
- **POST** `/api/memory/long-term` - å„²å­˜é•·æœŸè¨˜æ†¶
- **GET** `/api/memory/long-term` - ç²å–ç”¨æˆ¶é•·æœŸè¨˜æ†¶ï¼ˆæ”¯æ´æœƒè©±ç¯©é¸ï¼‰
- **GET** `/api/memory/sessions` - ç²å–ç”¨æˆ¶æœƒè©±åˆ—è¡¨

### ç®¡ç†å“¡é•·æœŸè¨˜æ†¶ API
- **GET** `/api/admin/long-term-memory` - ç²å–æ‰€æœ‰é•·æœŸè¨˜æ†¶è¨˜éŒ„ï¼ˆç®¡ç†å“¡ç”¨ï¼‰
- **GET** `/api/admin/memory-stats` - ç²å–é•·æœŸè¨˜æ†¶çµ±è¨ˆæ•¸æ“š

## éƒ¨ç½²åˆ° Zeabur

1. å°‡å°ˆæ¡ˆæ¨é€åˆ° GitHub
2. åœ¨ Zeabur å»ºç«‹æ–°å°ˆæ¡ˆ
3. é€£æ¥ GitHub å€‰åº«
4. è¨­å®šç’°å¢ƒè®Šæ•¸ `GEMINI_API_KEY`
5. éƒ¨ç½²æœå‹™

## å°ˆæ¡ˆçµæ§‹
```
backend/
â”œâ”€â”€ app.py              # ä¸»è¦æ‡‰ç”¨ç¨‹å¼
â”œâ”€â”€ Dockerfile          # å®¹å™¨åŒ–é…ç½®
â”œâ”€â”€ requirements.txt    # Python ä¾è³´å¥—ä»¶
â”œâ”€â”€ start.sh           # å¿«é€Ÿå•Ÿå‹•è…³æœ¬
â”œâ”€â”€ setup_env.sh       # ç’°å¢ƒè¨­å®šè…³æœ¬
â”œâ”€â”€ data/
â”‚   â””â”€â”€ kb.txt         # çŸ¥è­˜åº«æª”æ¡ˆ
â”œâ”€â”€ venv/              # è™›æ“¬ç’°å¢ƒï¼ˆæœ¬åœ°é–‹ç™¼ï¼‰
â””â”€â”€ README.md          # èªªæ˜æ–‡ä»¶
```

## å¸¸è¦‹å•é¡Œ

### Q: é‡åˆ° "externally-managed-environment" éŒ¯èª¤ï¼Ÿ
A: é€™æ˜¯ macOS ç³»çµ±ä¿è­·æ©Ÿåˆ¶ï¼Œè«‹ä½¿ç”¨è™›æ“¬ç’°å¢ƒï¼š
```bash
python3 -m venv venv
source venv/bin/activate
pip install uvicorn fastapi google-generativeai
```

### Q: æ¯æ¬¡éƒ½è¦é‡æ–°è¨­å®šç’°å¢ƒè®Šæ•¸ï¼Ÿ
A: ä½¿ç”¨æä¾›çš„ `start.sh` è…³æœ¬ï¼Œä¸€éµå•Ÿå‹•æ‰€æœ‰è¨­å®šã€‚

### Q: çŸ¥è­˜åº«è¼‰å…¥å¤±æ•—ï¼Ÿ
A: ç¢ºä¿ `data/kb.txt` æª”æ¡ˆå­˜åœ¨æ–¼å¾Œç«¯ç›®éŒ„ä¸­ã€‚

### Q: AI æ²’æœ‰å›æ‡‰ï¼Ÿ
A: æª¢æŸ¥ï¼š
1. API Key æ˜¯å¦æ­£ç¢ºè¨­å®š
2. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸
3. å¾Œç«¯æœå‹™æ˜¯å¦æ­£å¸¸é‹è¡Œ

## æ›´æ–°æ—¥èªŒ

### 2025-11-04 - BYOK (Bring Your Own Key) åŠŸèƒ½å¯¦ä½œ

#### ğŸš€ æ–°å¢åŠŸèƒ½
- **BYOK åŠŸèƒ½**ï¼šå…è¨±ç”¨æˆ¶ä½¿ç”¨è‡ªå·±çš„ LLM API Key
- **åŠ å¯†å­˜å„²**ï¼šä½¿ç”¨ Fernet å°ç¨±åŠ å¯†å®‰å…¨å­˜å„² API Key
- **å¤šæä¾›å•†æ”¯æ´**ï¼šæ”¯æ´ Google Gemini å’Œ OpenAI
- **è‡ªå‹•å„ªå…ˆä½¿ç”¨**ï¼šæ‰€æœ‰ LLM å‘¼å«è‡ªå‹•å„ªå…ˆä½¿ç”¨ç”¨æˆ¶çš„ API Key
- **å®Œæ•´ API ç«¯é»**ï¼š4 å€‹å®Œæ•´çš„ API ç«¯é»ç”¨æ–¼ç®¡ç†ç”¨æˆ¶çš„ API Key

#### ğŸ› ï¸ æŠ€è¡“ä¿®æ”¹
**æª”æ¡ˆï¼šapp.py**

**1. å°å…¥åŠ å¯†åº«ï¼ˆç´„ 13-19 è¡Œï¼‰**ï¼š
```python
try:
    from cryptography.fernet import Fernet
    CRYPTOGRAPHY_AVAILABLE = True
except ImportError:
    CRYPTOGRAPHY_AVAILABLE = False
```

**2. åŠ å¯†åŠŸèƒ½å¯¦ä½œï¼ˆç´„ 29-123 è¡Œï¼‰**ï¼š
- `get_encryption_key()`ï¼šç²å–åŠ å¯†é‡‘é‘°ï¼ˆå¾ç’°å¢ƒè®Šæ•¸æˆ–ç”Ÿæˆï¼‰
- `get_cipher()`ï¼šç²å– Fernet åŠ å¯†å™¨
- `encrypt_api_key()`ï¼šåŠ å¯† API Key
- `decrypt_api_key()`ï¼šè§£å¯† API Key
- `get_user_llm_key()`ï¼šç²å–ç”¨æˆ¶çš„ LLM API Keyï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰

**3. è³‡æ–™åº«è¡¨çµæ§‹ï¼ˆç´„ 352-365 è¡Œï¼‰**ï¼š
```sql
CREATE TABLE IF NOT EXISTS user_llm_keys (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    provider TEXT NOT NULL,
    encrypted_key TEXT NOT NULL,
    last4 TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user_profiles (user_id),
    UNIQUE(user_id, provider)
)
```

**4. API ç«¯é»å¯¦ä½œï¼ˆç´„ 6641-6840 è¡Œï¼‰**ï¼š
- `POST /api/user/llm-keys` - ä¿å­˜ API Key
- `GET /api/user/llm-keys/{user_id}` - ç²å–å·²ä¿å­˜çš„é‡‘é‘°è³‡è¨Š
- `POST /api/user/llm-keys/test` - æ¸¬è©¦ API Key æ˜¯å¦æœ‰æ•ˆ
- `DELETE /api/user/llm-keys/{user_id}` - æ¸…é™¤ API Key

**5. LLM å‘¼å«é‚è¼¯æ•´åˆ**ï¼š
- ä¿®æ”¹ `/api/generate/positioning`ï¼šå„ªå…ˆä½¿ç”¨ç”¨æˆ¶çš„ API Key
- ä¿®æ”¹ `/api/generate/topics`ï¼šå„ªå…ˆä½¿ç”¨ç”¨æˆ¶çš„ API Key
- ä¿®æ”¹ `/api/generate/script`ï¼šå„ªå…ˆä½¿ç”¨ç”¨æˆ¶çš„ API Key
- ä¿®æ”¹ `/api/chat/stream`ï¼šå„ªå…ˆä½¿ç”¨ç”¨æˆ¶çš„ API Key

#### ğŸ” å®‰å…¨æ€§æªæ–½
1. **åŠ å¯†å­˜å„²**ï¼š
   - ä½¿ç”¨ Fernet å°ç¨±åŠ å¯†ï¼ˆAES-128ï¼‰
   - åŠ å¯†é‡‘é‘°å¾ç’°å¢ƒè®Šæ•¸ `LLM_KEY_ENCRYPTION_KEY` è®€å–
   - å¦‚æœæœªè¨­å®šï¼Œæœƒç”Ÿæˆè‡¨æ™‚é‡‘é‘°ï¼ˆåƒ…ç”¨æ–¼é–‹ç™¼ï¼‰

2. **æ¬Šé™æ§åˆ¶**ï¼š
   - æ‰€æœ‰ API ç«¯é»éƒ½éœ€è¦ JWT token é©—è­‰
   - ç”¨æˆ¶åªèƒ½è¨ªå•è‡ªå·±çš„ API Key
   - ä½¿ç”¨ `get_current_user` ä¾è³´é …é©—è­‰ç”¨æˆ¶èº«ä»½

3. **æœ€å°åŒ–æš´éœ²**ï¼š
   - GET API åªè¿”å›æœ€å¾Œ4ä½æ•¸å­—ï¼Œä¸è¿”å›å®Œæ•´é‡‘é‘°
   - å®Œæ•´é‡‘é‘°åªåœ¨å¾Œç«¯å…§éƒ¨ä½¿ç”¨ï¼Œä¸æœƒå‚³éåˆ°å‰ç«¯

4. **HTTPS å‚³è¼¸**ï¼š
   - æ‰€æœ‰ API è«‹æ±‚éƒ½æ‡‰è©²é€šé HTTPS å‚³è¼¸
   - ç¢ºä¿ API Key åœ¨å‚³è¼¸éç¨‹ä¸­çš„å®‰å…¨æ€§

#### ğŸ“Š BYOK é‹ä½œæ–¹å¼

**1. ç”¨æˆ¶è¨­å®š API Key**ï¼š
```
ç”¨æˆ¶è¼¸å…¥ API Key
  â†“
å‰ç«¯ç™¼é€ POST /api/user/llm-keys
  â†“
å¾Œç«¯é©—è­‰ç”¨æˆ¶èº«ä»½
  â†“
å¾Œç«¯åŠ å¯† API Keyï¼ˆä½¿ç”¨ Fernetï¼‰
  â†“
å¾Œç«¯ä¿å­˜åˆ° user_llm_keys è¡¨
  â†“
è¿”å›æˆåŠŸè¨Šæ¯ï¼ˆåŒ…å«æœ€å¾Œ4ä½ï¼‰
```

**2. AI ç”Ÿæˆæ™‚è‡ªå‹•ä½¿ç”¨**ï¼š
```
ç”¨æˆ¶ç™¼èµ· AI ç”Ÿæˆè«‹æ±‚
  â†“
å¾Œç«¯æª¢æŸ¥æ˜¯å¦æœ‰ç”¨æˆ¶çš„ API Key
  â†“
å¦‚æœæœ‰ â†’ ä½¿ç”¨ç”¨æˆ¶çš„ API Key
å¦‚æœæ²’æœ‰ â†’ ä½¿ç”¨ç³»çµ±é è¨­çš„ GEMINI_API_KEY
  â†“
èª¿ç”¨ LLM APIï¼ˆGemini æˆ– OpenAIï¼‰
  â†“
è¿”å›ç”Ÿæˆçµæœ
```

**3. å„ªå…ˆç´šé‚è¼¯**ï¼š
```python
# æª¢æŸ¥æ˜¯å¦æœ‰ç”¨æˆ¶è‡ªå®šç¾©çš„ API Key
user_id = getattr(body, 'user_id', None)
user_api_key = get_user_llm_key(user_id, "gemini") if user_id else None

# å¦‚æœæ²’æœ‰ç”¨æˆ¶çš„ API Keyï¼Œä½¿ç”¨ç³»çµ±é è¨­çš„
api_key = user_api_key or os.getenv("GEMINI_API_KEY")

# ä½¿ç”¨ API Key é…ç½® LLM
genai.configure(api_key=api_key)
```

#### ğŸ”§ ç’°å¢ƒè®Šæ•¸è¨­å®š

**å¿…è¦ç’°å¢ƒè®Šæ•¸**ï¼š
```bash
# BYOK åŠ å¯†é‡‘é‘°ï¼ˆå¿…é ˆè¨­å®šï¼ï¼‰
LLM_KEY_ENCRYPTION_KEY=your_base64_encoded_fernet_key_here

# ç”ŸæˆåŠ å¯†é‡‘é‘°çš„æ–¹æ³•ï¼š
# python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

**ç³»çµ±é è¨­ API Keyï¼ˆå¦‚æœç”¨æˆ¶æ²’æœ‰è¨­å®šï¼‰**ï¼š
```bash
GEMINI_API_KEY=your_gemini_api_key
```

#### ğŸ“¦ ä¾è³´å¥—ä»¶

**æ–°å¢ä¾è³´**ï¼š
```bash
pip install cryptography
```

**requirements.txt æ›´æ–°**ï¼š
```
cryptography>=41.0.0
```

#### ğŸ¯ API ç«¯é»è©³æƒ…

**1. POST `/api/user/llm-keys` - ä¿å­˜ API Key**ï¼š
```json
// Request
{
  "user_id": "user123",
  "provider": "gemini",  // æˆ– "openai"
  "api_key": "AIzaSy..."
}

// Response
{
  "message": "API Key å·²å®‰å…¨ä¿å­˜",
  "provider": "gemini",
  "last4": "TR4"
}
```

**2. GET `/api/user/llm-keys/{user_id}` - ç²å–å·²ä¿å­˜çš„é‡‘é‘°**ï¼š
```json
// Response
{
  "keys": [
    {
      "provider": "gemini",
      "last4": "TR4",
      "created_at": "2025-11-04T10:00:00",
      "updated_at": "2025-11-04T10:00:00"
    }
  ]
}
```

**3. POST `/api/user/llm-keys/test` - æ¸¬è©¦ API Key**ï¼š
```json
// Request
{
  "provider": "gemini",
  "api_key": "AIzaSy..."
}

// Response (æˆåŠŸ)
{
  "valid": true,
  "message": "Gemini API Key æœ‰æ•ˆ"
}

// Response (å¤±æ•—)
{
  "valid": false,
  "error": "Gemini API Key ç„¡æ•ˆ: ..."
}
```

**4. DELETE `/api/user/llm-keys/{user_id}` - æ¸…é™¤ API Key**ï¼š
```json
// Request
{
  "provider": "gemini"
}

// Response
{
  "message": "API Key å·²åˆªé™¤",
  "provider": "gemini"
}
```

#### ğŸ¯ æ¸¬è©¦çµæœ
æ‰€æœ‰åŠŸèƒ½å·²é©—è­‰æ­£å¸¸ï¼š
- âœ… **è³‡æ–™åº«è¡¨å‰µå»º**ï¼š`user_llm_keys` è¡¨æ­£ç¢ºå‰µå»º
- âœ… **åŠ å¯†åŠŸèƒ½**ï¼šAPI Key æ­£ç¢ºåŠ å¯†å’Œè§£å¯†
- âœ… **ä¿å­˜ API Key**ï¼šæˆåŠŸä¿å­˜åˆ°è³‡æ–™åº«ä¸¦åŠ å¯†å­˜å„²
- âœ… **ç²å– API Key**ï¼šæ­£ç¢ºè¿”å›æœ€å¾Œ4ä½ï¼Œä¸æš´éœ²å®Œæ•´é‡‘é‘°
- âœ… **æ¸¬è©¦ API Key**ï¼šæ­£ç¢ºé©—è­‰ Gemini å’Œ OpenAI API Key
- âœ… **æ¸…é™¤ API Key**ï¼šæˆåŠŸåˆªé™¤ç”¨æˆ¶çš„ API Key
- âœ… **è‡ªå‹•ä½¿ç”¨**ï¼šæ‰€æœ‰ LLM å‘¼å«å„ªå…ˆä½¿ç”¨ç”¨æˆ¶çš„ API Key
- âœ… **æ¬Šé™æ§åˆ¶**ï¼šç”¨æˆ¶åªèƒ½è¨ªå•è‡ªå·±çš„ API Key

#### ğŸ“ é‡è¦æ³¨æ„äº‹é …

1. **åŠ å¯†é‡‘é‘°è¨­å®š**ï¼š
   - å¿…é ˆåœ¨ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®š `LLM_KEY_ENCRYPTION_KEY`
   - ä½¿ç”¨ Fernet ç”Ÿæˆçš„ base64 ç·¨ç¢¼é‡‘é‘°
   - ç”Ÿç”¢ç’°å¢ƒå¿…é ˆä½¿ç”¨å›ºå®šé‡‘é‘°ï¼Œä¸è¦ä½¿ç”¨è‡¨æ™‚ç”Ÿæˆçš„é‡‘é‘°

2. **è³‡æ–™åº«ç›¸å®¹æ€§**ï¼š
   - æ”¯æ´ SQLite å’Œ PostgreSQL
   - è‡ªå‹•è™•ç† SQL èªæ³•å·®ç•°
   - ä½¿ç”¨ `ON CONFLICT` æˆ– `INSERT OR REPLACE` è™•ç†é‡è¤‡

3. **éŒ¯èª¤è™•ç†**ï¼š
   - å¦‚æœ `cryptography` æœªå®‰è£ï¼ŒBYOK åŠŸèƒ½æœƒè‡ªå‹•ç¦ç”¨
   - å¦‚æœåŠ å¯†é‡‘é‘°æœªè¨­å®šï¼Œæœƒç”Ÿæˆè‡¨æ™‚é‡‘é‘°ä¸¦é¡¯ç¤ºè­¦å‘Š
   - æ‰€æœ‰éŒ¯èª¤éƒ½æœ‰è©³ç´°çš„æ—¥èªŒè¨˜éŒ„

4. **å‘å¾Œå…¼å®¹**ï¼š
   - å¦‚æœç”¨æˆ¶æ²’æœ‰è¨­å®šè‡ªå·±çš„ API Keyï¼Œç³»çµ±æœƒè‡ªå‹•ä½¿ç”¨ç³»çµ±é è¨­çš„ API Key
   - ä¸æœƒå½±éŸ¿ç¾æœ‰åŠŸèƒ½çš„æ­£å¸¸é‹ä½œ

#### ğŸ”„ èˆ‡å‰ç«¯æ•´åˆ

**å‰ç«¯è² è²¬**ï¼š
- UI/UX è¨­è¨ˆå’Œç”¨æˆ¶äº¤äº’
- API Key è¼¸å…¥å’Œé¡¯ç¤º
- èª¿ç”¨å¾Œç«¯ API ä¿å­˜ã€æ¸¬è©¦ã€æ¸…é™¤ API Key

**å¾Œç«¯è² è²¬**ï¼š
- API Key åŠ å¯†å­˜å„²
- æ¬Šé™é©—è­‰å’Œå®‰å…¨æ§åˆ¶
- LLM å‘¼å«æ™‚è‡ªå‹•ä½¿ç”¨ç”¨æˆ¶çš„ API Key
- æä¾›å®Œæ•´çš„ CRUD API ç«¯é»

#### ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

1. **å®‰è£ä¾è³´**ï¼š
   ```bash
   pip install cryptography
   ```

2. **ç”ŸæˆåŠ å¯†é‡‘é‘°**ï¼š
   ```bash
   python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
   ```

3. **è¨­å®šç’°å¢ƒè®Šæ•¸**ï¼š
   ```bash
   LLM_KEY_ENCRYPTION_KEY=<ç”Ÿæˆçš„åŠ å¯†é‡‘é‘°>
   ```

4. **é‡æ–°éƒ¨ç½²**ï¼š
   - ç¢ºä¿æ‰€æœ‰æ–°çš„ API ç«¯é»éƒ½å·²éƒ¨ç½²
   - ç¢ºä¿è³‡æ–™åº«è¡¨å·²å‰µå»º
   - æ¸¬è©¦æ‰€æœ‰åŠŸèƒ½

#### ğŸ“Š è³‡æ–™åº«çµæ§‹

**user_llm_keys è¡¨**ï¼š
- `id`ï¼šä¸»éµï¼Œè‡ªå‹•éå¢
- `user_id`ï¼šç”¨æˆ¶ IDï¼ˆå¤–éµï¼‰
- `provider`ï¼šæä¾›å•†ï¼ˆ'gemini' æˆ– 'openai'ï¼‰
- `encrypted_key`ï¼šåŠ å¯†å¾Œçš„ API Key
- `last4`ï¼šæœ€å¾Œ4ä½æ•¸å­—ï¼ˆç”¨æ–¼é¡¯ç¤ºï¼‰
- `created_at`ï¼šå‰µå»ºæ™‚é–“
- `updated_at`ï¼šæ›´æ–°æ™‚é–“
- `UNIQUE(user_id, provider)`ï¼šç¢ºä¿æ¯å€‹ç”¨æˆ¶æ¯å€‹æä¾›å•†åªæœ‰ä¸€å€‹é‡‘é‘°

---

### 2025-11-04 - é•·æœŸè¨˜æ†¶ç³»çµ±å®Œæ•´æ”¯æ´

#### âœ… ç³»çµ±ç‹€æ…‹ç¢ºèª

**é•·æœŸè¨˜æ†¶ API ç«¯é»**ï¼ˆå·²å®Œæ•´å¯¦ç¾ï¼‰ï¼š
- âœ… `POST /api/memory/long-term` - å„²å­˜é•·æœŸè¨˜æ†¶ï¼ˆå·²å¯¦ç¾ä¸¦æ­£å¸¸å·¥ä½œï¼‰
- âœ… `GET /api/memory/long-term` - ç²å–ç”¨æˆ¶é•·æœŸè¨˜æ†¶ï¼ˆæ”¯æ´æœƒè©±ç¯©é¸ï¼‰
- âœ… `GET /api/memory/sessions` - ç²å–ç”¨æˆ¶æœƒè©±åˆ—è¡¨

**ç®¡ç†å“¡é•·æœŸè¨˜æ†¶ API**ï¼ˆå·²å®Œæ•´å¯¦ç¾ï¼‰ï¼š
- âœ… `GET /api/admin/long-term-memory` - ç²å–æ‰€æœ‰é•·æœŸè¨˜æ†¶è¨˜éŒ„ï¼ˆç®¡ç†å“¡ç”¨ï¼‰
- âœ… `GET /api/admin/long-term-memory/by-user` - æŒ‰ç”¨æˆ¶åˆ†çµ„ç²å–é•·æœŸè¨˜æ†¶
- âœ… `GET /api/admin/memory-stats` - ç²å–é•·æœŸè¨˜æ†¶çµ±è¨ˆæ•¸æ“š

#### ğŸ” å‰ç«¯ä¿®å¾©å°æ‡‰

**å‰ç«¯ä¿®å¾©å…§å®¹**ï¼ˆæœ¬æ¬¡æ›´æ–°ï¼‰ï¼š
- âœ… ä¿®å¾© mode2ï¼ˆAI é¡§å•ï¼‰çš„é•·æœŸè¨˜æ†¶å„²å­˜åŠŸèƒ½
- âœ… ä¿®å¾© mode3ï¼ˆIP äººè¨­è¦åŠƒï¼‰çš„é‡è¤‡å„²å­˜å•é¡Œ
- âœ… ä¿®å¾© `index-ai-consultant.html` çš„é•·æœŸè¨˜æ†¶å„²å­˜åŠŸèƒ½
- âœ… åŠ å¼·æ—¥èªŒè¼¸å‡ºå’ŒéŒ¯èª¤è™•ç†

**å¾Œç«¯ç‹€æ…‹**ï¼š
- âœ… æ‰€æœ‰é•·æœŸè¨˜æ†¶ API ç«¯é»å·²å®Œæ•´å¯¦ç¾ä¸¦æ­£å¸¸å·¥ä½œ
- âœ… è³‡æ–™åº«è¡¨çµæ§‹å®Œæ•´ï¼ˆ`long_term_memory` è¡¨ï¼‰
- âœ… èªè­‰æ©Ÿåˆ¶æ­£å¸¸é‹ä½œ
- âœ… æœƒè©±ç®¡ç†åŠŸèƒ½å®Œæ•´

#### ğŸ“Š é•·æœŸè¨˜æ†¶å„²å­˜æµç¨‹

**å„²å­˜æµç¨‹**ï¼š
```
1. å‰ç«¯èª¿ç”¨ recordConversationMessage()
   â†“
2. ç™¼é€ POST /api/memory/long-term
   â†“
3. å¾Œç«¯é©—è­‰ token ä¸¦ç²å– user_id
   â†“
4. æ’å…¥åˆ° long_term_memory è¡¨
   â†“
5. è¿”å›æˆåŠŸè¨Šæ¯
```

**è³‡æ–™åº«çµæ§‹**ï¼š
```sql
CREATE TABLE long_term_memory (
    id SERIAL PRIMARY KEY,
    user_id TEXT NOT NULL,
    conversation_type TEXT NOT NULL,  -- 'ai_advisor' | 'ip_planning'
    session_id TEXT NOT NULL,
    message_role TEXT NOT NULL,       -- 'user' | 'assistant'
    message_content TEXT NOT NULL,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### ğŸ¯ æ”¯æ´çš„å°è©±é¡å‹

**mode2ï¼ˆAI é¡§å•ï¼‰**ï¼š
- `conversation_type: 'ai_advisor'`
- å‰ç«¯å·²ä¿®å¾©ï¼Œç¾åœ¨æœƒæ­£ç¢ºå„²å­˜é•·æœŸè¨˜æ†¶

**mode3ï¼ˆIP äººè¨­è¦åŠƒï¼‰**ï¼š
- `conversation_type: 'ip_planning'`
- å‰ç«¯å·²ä¿®å¾©é‡è¤‡å„²å­˜å•é¡Œ

#### ğŸ“ API ä½¿ç”¨ç¯„ä¾‹

**å„²å­˜é•·æœŸè¨˜æ†¶**ï¼š
```bash
POST /api/memory/long-term
Authorization: Bearer <token>
Content-Type: application/json

{
  "conversation_type": "ai_advisor",
  "session_id": "ai_advisor_xxx123",
  "message_role": "user",
  "message_content": "ç”¨æˆ¶è¨Šæ¯å…§å®¹"
}
```

**ç²å–é•·æœŸè¨˜æ†¶**ï¼š
```bash
GET /api/memory/long-term?conversation_type=ai_advisor&session_id=xxx123
Authorization: Bearer <token>
```

**ç²å–æœƒè©±åˆ—è¡¨**ï¼š
```bash
GET /api/memory/sessions?conversation_type=ai_advisor
Authorization: Bearer <token>
```

#### ğŸ¯ æ¸¬è©¦çµæœ

æ‰€æœ‰ API ç«¯é»å·²é©—è­‰æ­£å¸¸ï¼š
- âœ… **å„²å­˜é•·æœŸè¨˜æ†¶**ï¼šæ­£ç¢ºå„²å­˜ç”¨æˆ¶å’Œ AI çš„å°è©±è¨˜éŒ„
- âœ… **ç²å–é•·æœŸè¨˜æ†¶**ï¼šæ­£ç¢ºè¿”å›ç”¨æˆ¶çš„æ­·å²å°è©±
- âœ… **æœƒè©±ç®¡ç†**ï¼šæ­£ç¢ºç®¡ç†æœƒè©± ID å’Œæœƒè©±åˆ—è¡¨
- âœ… **ç®¡ç†å“¡ API**ï¼šæ­£ç¢ºè¿”å›æ‰€æœ‰ç”¨æˆ¶çš„é•·æœŸè¨˜æ†¶çµ±è¨ˆ
- âœ… **èªè­‰æ©Ÿåˆ¶**ï¼šæ­£ç¢ºé©—è­‰ token å’Œç”¨æˆ¶æ¬Šé™

#### ğŸ“ é‡è¦æ³¨æ„äº‹é …

1. **Token é©—è­‰**ï¼šæ‰€æœ‰é•·æœŸè¨˜æ†¶ API éƒ½éœ€è¦æœ‰æ•ˆçš„ JWT token
2. **ç”¨æˆ¶æ¬Šé™**ï¼šç”¨æˆ¶åªèƒ½è¨ªå•è‡ªå·±çš„é•·æœŸè¨˜æ†¶
3. **ç®¡ç†å“¡æ¬Šé™**ï¼šç®¡ç†å“¡å¯ä»¥æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ¶çš„é•·æœŸè¨˜æ†¶
4. **æœƒè©±ç®¡ç†**ï¼šå‰ç«¯æœƒè‡ªå‹•ç”Ÿæˆå’Œç®¡ç†æœƒè©± ID
5. **è³‡æ–™æŒä¹…åŒ–**ï¼šé•·æœŸè¨˜æ†¶æœƒæ°¸ä¹…å„²å­˜åœ¨è³‡æ–™åº«ä¸­

---

### 2025-10-29 - OAuth ç™»å…¥æµç¨‹å…¨é¢å„ªåŒ–

#### ğŸš€ æ–°å¢åŠŸèƒ½
- **æ”¹é€² OAuth Callback è™•ç†**ï¼šå¾Œç«¯ redirect åˆ°å‰ç«¯å°ˆç”¨çš„ `popup-callback.html` é é¢
- **URL åƒæ•¸å‚³é**ï¼šé€šé URL åƒæ•¸å®‰å…¨åœ°å‚³é token å’Œç”¨æˆ¶è³‡è¨Š
- **COOP æ¨™é ­è¨­ç½®**ï¼šæ·»åŠ  `Cross-Origin-Opener-Policy: same-origin-allow-popups` æ”¯æ´å½ˆçª—é€šä¿¡
- **Token Refresh æ”¹é€²**ï¼šå…è¨±éæœŸ token ç”¨æ–¼ refreshï¼Œæ”¹é€²éŒ¯èª¤è™•ç†

#### ğŸ› ï¸ æŠ€è¡“ä¿®æ”¹
**æª”æ¡ˆï¼šapp.py**

**1. OAuth Callback æ”¹é€²**ï¼š
- ç§»é™¤å…§åµŒ HTML é é¢çš„è¤‡é›œ postMessage é‚è¼¯
- æ”¹ç‚ºç°¡å–®çš„ redirect åˆ° `https://aivideonew.zeabur.app/auth/popup-callback.html`
- ä½¿ç”¨ URL åƒæ•¸å‚³é tokenã€user_idã€emailã€nameã€picture
- ä½¿ç”¨ `urllib.parse.quote()` ç¢ºä¿åƒæ•¸å®‰å…¨ç·¨ç¢¼
- æ·»åŠ  COOP å’Œ CORS æ¨™é ­æ”¯æ´è·¨åŸŸé€šä¿¡

**2. Token Refresh æ”¹é€²**ï¼š
- æ–°å¢ `get_current_user_for_refresh()` å‡½æ•¸ï¼šå…è¨±æ¥å—éæœŸä½†æœ‰æ•ˆç°½åçš„ token
- ä¿®æ”¹ `verify_access_token()` å‡½æ•¸ï¼šæ·»åŠ  `allow_expired` åƒæ•¸
- æ”¹é€² `/api/auth/refresh` ç«¯é»ï¼šä½¿ç”¨æ–°çš„ refresh ä¾è³´é …ï¼Œæ·»åŠ è©³ç´°çš„ DEBUG æ—¥èªŒ
- ç§»é™¤ user_id è¦æ±‚ï¼šæ”¹å›ä½¿ç”¨ `Authorization` headerï¼ˆæ¨™æº–åšæ³•ï¼‰

**3. éŒ¯èª¤è™•ç†æ”¹é€²**ï¼š
- æ”¹é€² OAuth callback éŒ¯èª¤é é¢çš„ postMessage ç™¼é€
- ç§»é™¤ `window.opener.closed` æª¢æŸ¥ï¼Œé¿å… COOP éŒ¯èª¤
- æ·»åŠ æ›´è©³ç´°çš„ DEBUG æ—¥èªŒè¨˜éŒ„

#### ğŸ“Š API ç«¯é»æ›´æ–°

**OAuth ç«¯é»**ï¼š
- `GET /api/auth/google` - ç”Ÿæˆ Google OAuth URL
- `GET /api/auth/google/callback` - è™•ç† OAuth callbackï¼ˆ**å·²æ”¹ç‚º redirect åˆ°å‰ç«¯**ï¼‰

**Token ç®¡ç†ç«¯é»**ï¼š
- `POST /api/auth/refresh` - åˆ·æ–° access tokenï¼ˆ**æ”¯æ´éæœŸ token**ï¼‰
- `GET /api/auth/me` - ç²å–ç•¶å‰ç”¨æˆ¶è³‡è¨Š

#### ğŸ”§ é—œéµå•é¡Œä¿®å¾©
1. **OAuth Callback è¤‡é›œæ€§å•é¡Œ**ï¼š
   - **å•é¡Œ**ï¼šå…§åµŒ HTML é é¢çš„ postMessage é‚è¼¯è¤‡é›œä¸”å®¹æ˜“å¤±æ•—
   - **è§£æ±º**ï¼šæ”¹ç‚º redirect åˆ°å‰ç«¯å°ˆç”¨é é¢ï¼Œç”±å‰ç«¯çµ±ä¸€è™•ç†

2. **Token Refresh å¤±æ•—å•é¡Œ**ï¼š
   - **å•é¡Œ**ï¼šéæœŸ token ç„¡æ³•ç”¨æ–¼ refreshï¼Œå°è‡´ 401 éŒ¯èª¤å¾ªç’°
   - **è§£æ±º**ï¼šå…è¨±éæœŸä½†æœ‰æ•ˆç°½åçš„ token ç”¨æ–¼ refresh

3. **COOP éŒ¯èª¤å•é¡Œ**ï¼š
   - **å•é¡Œ**ï¼šæª¢æŸ¥ `window.opener.closed` è§¸ç™¼ COOP éŒ¯èª¤
   - **è§£æ±º**ï¼šç§»é™¤æ‰€æœ‰ `window.opener.closed` æª¢æŸ¥

4. **URL åƒæ•¸å®‰å…¨å•é¡Œ**ï¼š
   - **å•é¡Œ**ï¼šç”¨æˆ¶è³‡æ–™ç›´æ¥åµŒå…¥ URL å¯èƒ½ä¸å®‰å…¨
   - **è§£æ±º**ï¼šä½¿ç”¨ `urllib.parse.quote()` æ­£ç¢ºç·¨ç¢¼æ‰€æœ‰åƒæ•¸

#### ğŸ¯ å·¥ä½œæµç¨‹

**ç™»å…¥æµç¨‹**ï¼š
```
1. ç”¨æˆ¶é»æ“Šç™»å…¥
   â†“
2. å‰ç«¯è«‹æ±‚ /api/auth/google
   â†“
3. å¾Œç«¯è¿”å› Google OAuth URL
   â†“
4. ç”¨æˆ¶å®Œæˆ Google ç™»å…¥
   â†“
5. Google redirect åˆ° /api/auth/google/callback?code=...
   â†“
6. å¾Œç«¯äº¤æ› code ç²å– access_token
   â†“
7. å¾Œç«¯ç²å–ç”¨æˆ¶è³‡è¨Šä¸¦ç”Ÿæˆæ‡‰ç”¨ access token
   â†“
8. å¾Œç«¯ redirect åˆ°å‰ç«¯ popup-callback.html?token=...&user_id=...
   â†“
9. å‰ç«¯ popup-callback.html è™•ç† token ä¸¦é€šçŸ¥ä¸»è¦–çª—
   â†“
10. ä¸»è¦–çª—æ›´æ–°ç™»å…¥ç‹€æ…‹ âœ…
```

#### ğŸ“ ç’°å¢ƒè®Šæ•¸é…ç½®

**å¿…è¦ç’°å¢ƒè®Šæ•¸**ï¼š
- `GOOGLE_CLIENT_ID` - Google OAuth Client ID
- `GOOGLE_CLIENT_SECRET` - Google OAuth Client Secret
- `OAUTH_REDIRECT_URI` - OAuth redirect URIï¼ˆå»ºè­°ï¼š`https://aivideobackend.zeabur.app/api/auth/google/callback`ï¼‰
- `JWT_SECRET` - JWT ç°½åå¯†é‘°ï¼ˆ**å¿…é ˆæ˜¯å›ºå®šå€¼**ï¼Œå»ºè­°ï¼š`u5c1N4kQm8Zf2Tg7Pp9Lr3Xw6Yd0Aq2H`ï¼‰

**æ³¨æ„äº‹é …**ï¼š
- `JWT_SECRET` å¿…é ˆåœ¨ Zeabur ç’°å¢ƒè®Šæ•¸ä¸­è¨­å®šç‚ºå›ºå®šå€¼
- å¦‚æœ `JWT_SECRET` æ”¹è®Šï¼Œæ‰€æœ‰ç¾æœ‰çš„ token éƒ½æœƒå¤±æ•ˆ
- Google OAuth `redirect_uri` éœ€è¦æ›´æ–°ç‚ºå‰ç«¯çš„ `popup-callback.html`

#### ğŸ¯ æ¸¬è©¦çµæœ
æ‰€æœ‰åŠŸèƒ½å·²é©—è­‰æ­£å¸¸ï¼š
- âœ… **OAuth Callback**ï¼šæ­£ç¢º redirect åˆ°å‰ç«¯é é¢
- âœ… **URL åƒæ•¸ç·¨ç¢¼**ï¼šå®‰å…¨è™•ç†æ‰€æœ‰ç”¨æˆ¶è³‡æ–™
- âœ… **Token Refresh**ï¼šæ”¯æ´éæœŸ token åˆ·æ–°
- âœ… **COOP æ¨™é ­**ï¼šæ­£ç¢ºè¨­ç½®æ”¯æ´å½ˆçª—é€šä¿¡
- âœ… **éŒ¯èª¤è™•ç†**ï¼šå®Œæ•´çš„éŒ¯èª¤è¨Šæ¯å’Œæ—¥èªŒè¨˜éŒ„

#### ğŸ“ ç¶“é©—ç¸½çµ
1. **ç°¡åŒ– Callback é‚è¼¯**ï¼šå°‡è¤‡é›œçš„ postMessage é‚è¼¯ç§»åˆ°å‰ç«¯ï¼Œå¾Œç«¯åªè² è²¬è³‡æ–™è™•ç†å’Œ redirect
2. **URL åƒæ•¸å®‰å…¨**ï¼šä½¿ç”¨æ­£ç¢ºçš„ç·¨ç¢¼ç¢ºä¿ç‰¹æ®Šå­—ç¬¦ä¸æœƒç ´å£ URL
3. **Token ç®¡ç†**ï¼šå…è¨±éæœŸ token ç”¨æ–¼ refresh æä¾›æ›´å¥½çš„ç”¨æˆ¶é«”é©—
4. **COOP æ¨™é ­**ï¼šæ­£ç¢ºè¨­ç½® COOP æ¨™é ­æ”¯æ´ç¾ä»£ç€è¦½å™¨çš„è·¨åŸŸé€šä¿¡å®‰å…¨æ”¿ç­–

---

## ğŸ§¾ é‡‘æµä¸²æ¥ä»£è¾¦ï¼ˆBackend TODOï¼‰

1. é‡‘æµä¾›æ‡‰å•†é¸æ“‡èˆ‡æ²™ç®±é–‹é€šï¼šECPay / NewebPay / TapPayï¼ˆæ“‡ä¸€ï¼‰ã€‚
2. è¨­è¨ˆå›èª¿å®‰å…¨ï¼š
   - åŠ å…¥ç°½ç« é©—è­‰ï¼ˆHMAC/æª¢æ ¸ç¢¼ï¼‰ï¼Œæ¯”å°äº¤æ˜“åƒæ•¸èˆ‡é‡‘é¡ã€‚
   - ç™½åå–®é™åˆ¶ä¾†æº IP/ç¶²åŸŸã€‚
   - é˜²æ­¢é‡æ”¾ï¼štransaction_id å»é‡ï¼ˆå”¯ä¸€ç´¢å¼•ï¼‰ã€‚
3. è¨‚å–®æµç¨‹ï¼š
   - å»ºç«‹ `orders`ï¼ˆpendingï¼‰â†’ ä»˜æ¬¾å®Œæˆï¼ˆpaidï¼‰â†’ æ›´æ–° `licenses` èˆ‡ `user_auth.is_subscribed=1`ã€‚
   - å¹´/æœˆæ–¹æ¡ˆï¼šè¨ˆç®— `expires_at`ï¼ˆ30 å¤©æˆ– 365 å¤©ï¼‰ã€‚
4. API ä»‹é¢ï¼š
   - `POST /api/payment/checkout`ï¼šå»ºç«‹è¨‚å–®ä¸¦å–å¾—ç¬¬ä¸‰æ–¹ CheckOut URLã€‚
   - `POST /api/payment/webhook`ï¼šç¬¬ä¸‰æ–¹ä¼ºæœå™¨ç«¯é€šçŸ¥ï¼ˆå¿…éœ€é©—ç°½ï¼‰ã€‚
   - `GET /api/payment/return`ï¼šä½¿ç”¨è€…ç€è¦½å™¨è¿”å›é ï¼ˆé¡¯ç¤ºçµæœï¼‰ã€‚
   - ç›®å‰æš«ç”¨ `/api/payment/callback` åšç‚ºæ¸¬è©¦ç«¯é»ï¼Œå¾ŒçºŒæ›¿æ›ç‚º webhook/return é›™è»Œã€‚
5. è¨­å®šæª”èˆ‡ç’°å¢ƒè®Šæ•¸ï¼š`PAYMENT_MERCHANT_ID`ã€`PAYMENT_HASH_KEY`ã€`PAYMENT_HASH_IV`ã€`PAYMENT_RETURN_URL`ã€`PAYMENT_NOTIFY_URL`ã€‚
6. æ—¥èªŒèˆ‡å°å¸³ï¼šä¸²æ¥äº¤æ˜“æµæ°´ï¼Œå»ºç«‹æ¯æ—¥å°å¸³æ‰¹æ¬¡ï¼ˆCSV åŒ¯å‡ºæˆ– API æ‹‰å–ï¼‰ã€‚

### 2025-10-28 - ä¸Šæ¶å‰å®Œæ•´åŠŸèƒ½æ›´æ–°

#### ğŸš€ æ–°å¢åŠŸèƒ½
- **ç®¡ç†å¾Œå°å®Œæ•´ API ç«¯é»**ï¼šæ–°å¢ 6 å€‹ç®¡ç†å¾Œå°å°ˆç”¨ API
- **è¨‚é–±ç®¡ç†åŠŸèƒ½**ï¼šç®¡ç†å“¡å¯æ‰‹å‹•è¨­å®šç”¨æˆ¶è¨‚é–±ç‹€æ…‹
- **CSV åŒ¯å‡ºåŠŸèƒ½**ï¼šæ”¯æ´åŒ¯å‡ºç”¨æˆ¶ã€è…³æœ¬ã€å°è©±ã€ç”Ÿæˆè¨˜éŒ„
- **çœŸå¯¦æ•¸æ“šæ•´åˆ**ï¼šæ‰€æœ‰åœ–è¡¨å’Œçµ±è¨ˆéƒ½ä½¿ç”¨çœŸå¯¦è³‡æ–™åº«æ•¸æ“š
- **PostgreSQL å®Œæ•´æ”¯æ´**ï¼šè‡ªå‹•è™•ç† SQLite å’Œ PostgreSQL èªæ³•å·®ç•°
- **æ™‚å€è™•ç†**ï¼šæ­£ç¢ºè™•ç†å°ç£æ™‚å€ (UTC+8) çš„æ—¥æœŸé¡¯ç¤º

#### ğŸ“Š æ–°å¢ API ç«¯é»
1. `GET /api/admin/mode-statistics` - æ¨¡å¼ä½¿ç”¨çµ±è¨ˆ
2. `GET /api/admin/generations` - ç”Ÿæˆè¨˜éŒ„åˆ—è¡¨
3. `GET /api/admin/platform-statistics` - å¹³å°ä½¿ç”¨çµ±è¨ˆ
4. `GET /api/admin/user-activities` - æœ€è¿‘ç”¨æˆ¶æ´»å‹•
5. `GET /api/admin/analytics-data` - åˆ†æé é¢æ•¸æ“š
6. `PUT /api/admin/users/{user_id}/subscription` - æ›´æ–°è¨‚é–±ç‹€æ…‹
7. `GET /api/admin/export/{type}.csv` - CSV åŒ¯å‡º
8. `GET /api/admin/conversations` - ç²å–æ‰€æœ‰å°è©±è¨˜éŒ„ï¼ˆæ–°å¢ï¼‰
9. `GET /api/admin/scripts` - ç²å–æ‰€æœ‰è…³æœ¬è¨˜éŒ„ï¼ˆæ–°å¢ï¼‰

#### ğŸ› ï¸ æŠ€è¡“ä¿®æ”¹
- **SQL èªæ³•å…¼å®¹æ€§**ï¼šè‡ªå‹•è™•ç† SQLite (`?`) å’Œ PostgreSQL (`%s`) çš„ä½”ä½ç¬¦å·®ç•°
- **INSERT OR REPLACE ä¿®å¾©**ï¼šPostgreSQL ä½¿ç”¨ `ON CONFLICT ... DO UPDATE SET` èªæ³•
- **æ™‚æˆ³é¡å‹ä¿®å¾©**ï¼šPostgreSQL ä½¿ç”¨ datetime å°è±¡ï¼ŒSQLite ä½¿ç”¨ Unix timestamp
- **æ™‚å€è½‰æ›**ï¼šæ‰€æœ‰æ—¥æœŸé¡¯ç¤ºè½‰æ›ç‚ºå°ç£æ™‚å€ (UTC+8)
- **ç”¨æˆ¶è¨‚é–±ç‹€æ…‹**ï¼šæ–°å¢ `is_subscribed` æ¬„ä½ï¼Œé»˜èªå€¼ç‚º 1ï¼ˆå·²è¨‚é–±ï¼‰

#### ğŸ¯ è¨‚é–±ç®¡ç†
- **API ç«¯é»**ï¼š`PUT /api/admin/users/{user_id}/subscription`
- **åŠŸèƒ½**ï¼šç®¡ç†å“¡å¯æ‰‹å‹•å•Ÿç”¨æˆ–å–æ¶ˆç”¨æˆ¶è¨‚é–±
- **æ”¯æ´**ï¼šPostgreSQL å’Œ SQLite
- **è‡ªå‹•æ›´æ–°**ï¼šå³æ™‚æ›´æ–° UI é¡¯ç¤º

#### ğŸ“¥ CSV åŒ¯å‡º
- **æ”¯æ´é¡å‹**ï¼šusers, scripts, conversations, generations
- **è‡ªå‹•ä¸‹è¼‰**ï¼šé»æ“ŠåŒ¯å‡ºæŒ‰éˆ•è‡ªå‹•ä¸‹è¼‰æª”æ¡ˆ
- **å®Œæ•´æ•¸æ“š**ï¼šåŒ…å«æ‰€æœ‰ç›¸é—œæ¬„ä½

#### ğŸ› ï¸ PostgreSQL å®Œæ•´æ”¯æ´
- **å„ªå…ˆä½¿ç”¨**ï¼šæœ‰ `DATABASE_URL` æ™‚è‡ªå‹•ä½¿ç”¨ PostgreSQL
- **å‘å¾Œå…¼å®¹**ï¼šæ²’æœ‰ PostgreSQL æ™‚è‡ªå‹•å›é€€åˆ° SQLite
- **èªæ³•å…¼å®¹**ï¼šè‡ªå‹•è™•ç† SQLite å’Œ PostgreSQL èªæ³•å·®ç•°

#### ğŸ”§ é—œéµå•é¡Œä¿®å¾©
1. **Google OAuth ç™»å…¥ä¿®å¾©**ï¼š
   - ä¿®å¾© `INSERT OR REPLACE` èªæ³•åœ¨ PostgreSQL çš„å…¼å®¹æ€§å•é¡Œ
   - ä½¿ç”¨ `ON CONFLICT ... DO UPDATE SET` æ›¿ä»£ SQLite ç‰¹æœ‰èªæ³•
   - ä¿®å¾© `expires_at` æ¬„ä½çš„é¡å‹ä¸åŒ¹é…å•é¡Œï¼ˆtimestamp vs numericï¼‰

2. **æ™‚å€è™•ç†ä¿®å¾©**ï¼š
   - æ‰€æœ‰æ—¥æœŸé¡¯ç¤ºè½‰æ›ç‚ºå°ç£æ™‚å€ (UTC+8)
   - `/api/auth/me` å’Œ `/api/admin/users` æ­£ç¢ºæ ¼å¼åŒ–æ—¥æœŸ
   - ä½¿ç”¨ `datetime.astimezone()` ç¢ºä¿æ™‚é–“é¡¯ç¤ºæ­£ç¢º

3. **SQL èªæ³•è‡ªå‹•è½‰æ›**ï¼š
   - ä½”ä½ç¬¦è‡ªå‹•è½‰æ›ï¼šSQLite (`?`) â†’ PostgreSQL (`%s`)
   - æ—¥æœŸå‡½æ•¸å…¼å®¹ï¼šSQLite (`datetime('now')`) â†’ PostgreSQL (`CURRENT_TIMESTAMP`)
   - RETURNING èªæ³•ï¼šPostgreSQL ä½¿ç”¨ `RETURNING id`ï¼ŒSQLite ä½¿ç”¨ `lastrowid`

4. **æ•¸æ“šé¡¯ç¤ºä¿®å¾©**ï¼š
   - ç”¨æˆ¶åˆ—è¡¨æ­£ç¢ºé¡¯ç¤ºå°è©±æ•¸å’Œè…³æœ¬æ•¸
   - ä¿®æ­£ã€Œè¨»å†Šæ™‚é–“ã€å’Œã€Œè¨‚é–±ç‹€æ…‹ã€æ¬„ä½é¡¯ç¤ºé †åº
   - æ‰€æœ‰çµ±è¨ˆæ•¸æ“šä½¿ç”¨çœŸå¯¦è³‡æ–™åº«æ•¸æ“šï¼Œå®Œå…¨ç§»é™¤å‡æ•¸æ“š

### 2025-10-27 - è³‡æ–™åº«æŒä¹…åŒ–é…ç½®èˆ‡è¨‚é–±ç‹€æ…‹ä¿®å¾©

#### ğŸš€ æ–°å¢åŠŸèƒ½
- **ç’°å¢ƒè®Šæ•¸æ”¯æ´**ï¼šä½¿ç”¨ `DATABASE_PATH` ç’°å¢ƒè®Šæ•¸æ”¯æ´æŒä¹…åŒ–å­˜å„²é…ç½®
- **è¨‚é–±ç‹€æ…‹ä¿®å¾©**ï¼šä¿®æ­£ `is_subscribed` æ¬„ä½çš„è™•ç†é‚è¼¯ï¼Œç¢ºä¿æ­£ç¢ºè®€å–è¨‚é–±ç‹€æ…‹
- **è³‡æ–™åº«æ¬„ä½è£œé½Š**ï¼šè‡ªå‹•æª¢æŸ¥ä¸¦æ–°å¢ `is_subscribed` æ¬„ä½åˆ°ç¾æœ‰è³‡æ–™åº«
- **é è¨­è¨‚é–±è¨­å®š**ï¼šæ–°è¨»å†Šç”¨æˆ¶é è¨­ç‚ºå·²è¨‚é–±ç‹€æ…‹

#### ğŸ› ï¸ æŠ€è¡“ä¿®æ”¹
**æª”æ¡ˆï¼šapp.py**

**1. è³‡æ–™åº«è·¯å¾‘é…ç½®**ï¼š
- ä¿®æ”¹ `init_database()` å‡½æ•¸æ”¯æ´ç’°å¢ƒè®Šæ•¸ `DATABASE_PATH`
- é è¨­è·¯å¾‘ç‚º `./data`ï¼Œå¯é€šéç’°å¢ƒè®Šæ•¸è¨­å®šç‚º `/persistent` ç­‰æŒä¹…åŒ–è·¯å¾‘
- ä¿®æ”¹ `get_db_connection()` å‡½æ•¸ä½¿ç”¨ç›¸åŒçš„è·¯å¾‘é‚è¼¯
- æ·»åŠ è·¯å¾‘å‰µå»ºå’Œæ—¥èªŒè¨˜éŒ„

```python
def init_database():
    # å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸æŒ‡å®šçš„è·¯å¾‘ï¼ˆæŒä¹…åŒ–å­˜å„²ï¼‰
    db_dir = os.getenv("DATABASE_PATH", os.path.join(os.path.dirname(os.path.abspath(__file__)), "data"))
    db_path = os.path.join(db_dir, "chatbot.db")
    os.makedirs(os.path.dirname(db_path), exist_ok=True)
```

**2. è¨‚é–±ç‹€æ…‹è™•ç†**ï¼š
- ä¿®æ”¹ `google_callback_get()` å‡½æ•¸ï¼šæ–°ç”¨æˆ¶è¨»å†Šæ™‚è¨­å®š `is_subscribed = 1`
- ä¿®æ”¹ `get_current_user_info()` å‡½æ•¸ï¼šæ­£ç¢ºè™•ç† `is_subscribed` æ¬„ä½çš„å„ç¨®é¡å‹
- æ·»åŠ é è¨­å€¼è™•ç†ï¼šå¦‚æœæ¬„ä½ç‚º `None`ï¼Œé è¨­è¨­ç‚º `True`ï¼ˆå·²è¨‚é–±ï¼‰

```python
# å°‡æ‰€æœ‰ç¾æœ‰ç”¨æˆ¶çš„è¨‚é–±ç‹€æ…‹è¨­ç‚º 1ï¼ˆå·²è¨‚é–±ï¼‰
cursor.execute("UPDATE user_auth SET is_subscribed = 1 WHERE is_subscribed IS NULL OR is_subscribed = 0")
```

**3. è³‡æ–™åº«çµæ§‹æ›´æ–°**ï¼š
- åœ¨ `init_database()` ä¸­æ·»åŠ  `ALTER TABLE` èªå¥æª¢æŸ¥ä¸¦æ–°å¢ `is_subscribed` æ¬„ä½
- å¦‚æœæ¬„ä½ä¸å­˜åœ¨ï¼Œè‡ªå‹•æ–°å¢
- å¦‚æœæ¬„ä½å·²å­˜åœ¨ï¼Œè·³éæ–°å¢æ­¥é©Ÿ
- å°‡æ‰€æœ‰ç¾æœ‰ç”¨æˆ¶çš„ `is_subscribed` è¨­å®šç‚º 1ï¼ˆå·²è¨‚é–±ï¼‰

#### ğŸ“Š è³‡æ–™åº«é…ç½®

**æœ¬åœ°é–‹ç™¼ç’°å¢ƒ**ï¼š
```bash
DATABASE_PATH=./data  # é è¨­ï¼Œå­˜å„²åœ¨ backend/data/chatbot.db
```

**Zeabur éƒ¨ç½²ç’°å¢ƒ**ï¼š
```bash
DATABASE_PATH=/persistent  # æŒä¹…åŒ–å­˜å„²è·¯å¾‘
```

éœ€è¦åœ¨ Zeabur é…ç½® Persistent Storage ä¸¦æ›è¼‰åˆ° `/persistent` ç›®éŒ„ã€‚

#### ğŸ¯ åŠŸèƒ½ç‰¹é»
- **æŒä¹…åŒ–å­˜å„²æ”¯æ´**ï¼šé€šéç’°å¢ƒè®Šæ•¸é…ç½®è³‡æ–™åº«è·¯å¾‘ï¼Œæ”¯æ´ Zeabur Persistent Storage
- **å‘å¾Œå…¼å®¹**ï¼šè‡ªå‹•è™•ç†è³‡æ–™åº«çµæ§‹è®Šæ›´ï¼Œä¸å½±éŸ¿ç¾æœ‰ç”¨æˆ¶
- **é è¨­è¨‚é–±**ï¼šæ‰€æœ‰ç”¨æˆ¶é è¨­ç‚ºå·²è¨‚é–±ç‹€æ…‹ï¼Œæ–¹ä¾¿æ¸¬è©¦å’Œé–‹ç™¼
- **é¡å‹å®‰å…¨**ï¼šæ­£ç¢ºè™•ç† `is_subscribed` æ¬„ä½çš„å„ç¨®é¡å‹ï¼ˆboolean, int, stringï¼‰

#### ğŸ“ ä¿®æ”¹ç´°ç¯€
- **è³‡æ–™åº«åˆå§‹åŒ–**ï¼šæ·»åŠ  `ALTER TABLE` æª¢æŸ¥ï¼Œç¢ºä¿ `is_subscribed` æ¬„ä½å­˜åœ¨
- **é¡å‹è½‰æ›**ï¼šä½¿ç”¨ `bool(row[4])` ç¢ºä¿è¿”å›æ­£ç¢ºçš„å¸ƒæ—å€¼
- **é è¨­å€¼è™•ç†**ï¼šå¦‚æœ `is_subscribed` ç‚º `None`ï¼Œé è¨­è¨­ç‚º `True`
- **è·¯å¾‘é…ç½®**ï¼šçµ±ä¸€ä½¿ç”¨ `DATABASE_PATH` ç’°å¢ƒè®Šæ•¸é…ç½®è³‡æ–™åº«è·¯å¾‘

#### ğŸ¯ æ¸¬è©¦çµæœ
æ‰€æœ‰åŠŸèƒ½å·²é©—è­‰æ­£å¸¸ï¼š
- âœ… **è³‡æ–™åº«è·¯å¾‘é…ç½®**ï¼šæ­£ç¢ºè®€å–ç’°å¢ƒè®Šæ•¸ä¸¦è¨­å®šè³‡æ–™åº«è·¯å¾‘
- âœ… **è¨‚é–±ç‹€æ…‹ä¿®å¾©**ï¼š`is_subscribed` æ¬„ä½æ­£ç¢ºè®€å–å’Œè™•ç†
- âœ… **æ–°ç”¨æˆ¶è¨»å†Š**ï¼šæ–°ç”¨æˆ¶è‡ªå‹•è¨­å®šç‚ºå·²è¨‚é–±
- âœ… **è³‡æ–™åº«çµæ§‹æ›´æ–°**ï¼šè‡ªå‹•æª¢æŸ¥ä¸¦æ–°å¢ç¼ºå¤±çš„æ¬„ä½
- âœ… **å‘å¾Œå…¼å®¹**ï¼šä¸å½±éŸ¿ç¾æœ‰ç”¨æˆ¶çš„è³‡æ–™å’ŒåŠŸèƒ½

#### ğŸ“ ç¶“é©—ç¸½çµ
1. **æŒä¹…åŒ–å­˜å„²**ï¼šä½¿ç”¨ç’°å¢ƒè®Šæ•¸é…ç½®è³‡æ–™åº«è·¯å¾‘ï¼Œæ”¯æ´å®¹å™¨åŒ–éƒ¨ç½²çš„æŒä¹…åŒ–å­˜å„²éœ€æ±‚
2. **è³‡æ–™åº«é·ç§»**ï¼šé€šé `ALTER TABLE` å’Œ `UPDATE` èªå¥å¯¦ç¾å¹³æ»‘çš„è³‡æ–™åº«çµæ§‹æ›´æ–°
3. **é¡å‹è™•ç†**ï¼šè€ƒæ…®è³‡æ–™åº«æ¬„ä½çš„ä¸åŒé¡å‹ï¼Œç¢ºä¿æ­£ç¢ºçš„é¡å‹è½‰æ›
4. **é è¨­å€¼ç­–ç•¥**ï¼šé è¨­è¨­ç‚ºå·²è¨‚é–±ç‹€æ…‹ï¼Œé™ä½æ¸¬è©¦å’Œé–‹ç™¼çš„é–€æª»
5. **Zeabur éƒ¨ç½²**ï¼šé…ç½® Persistent Storage æ›è¼‰åˆ° `/persistent` ç›®éŒ„ï¼Œç¢ºä¿è³‡æ–™æŒä¹…åŒ–

#### âš ï¸ éƒ¨ç½²æ³¨æ„äº‹é …
1. **Zeabur Persistent Storage**ï¼š
   - åœ¨ Zeabur å°ˆæ¡ˆè¨­å®šä¸­å•Ÿç”¨ Persistent Storage
   - è¨­å®šæ›è¼‰è·¯å¾‘ç‚º `/persistent`
   - è¨­å®šç’°å¢ƒè®Šæ•¸ `DATABASE_PATH=/persistent`

2. **è³‡æ–™é·ç§»**ï¼š
   - é¦–æ¬¡éƒ¨ç½²æ™‚ï¼Œè³‡æ–™åº«æœƒè‡ªå‹•æ–°å¢ `is_subscribed` æ¬„ä½
   - ç¾æœ‰ç”¨æˆ¶çš„è¨‚é–±ç‹€æ…‹æœƒè‡ªå‹•è¨­ç‚º 1ï¼ˆå·²è¨‚é–±ï¼‰
   - ä¸éœ€è¦æ‰‹å‹•åŸ·è¡Œé·ç§»è…³æœ¬

3. **è³‡æ–™å‚™ä»½**ï¼š
   - å•Ÿç”¨ Persistent Storage å¾Œï¼Œè³‡æ–™æœƒä¿å­˜åˆ°æ›è¼‰çš„å·
   - å®šæœŸå‚™ä»½ `/persistent` ç›®éŒ„çš„è³‡æ–™

---

### 2025-01-21 - é‡å¤§æ›´æ–°ï¼šå¯¦ç¾é•·æœŸè¨˜æ†¶èˆ‡å€‹äººåŒ–åŠŸèƒ½

#### ğŸš€ æ–°å¢åŠŸèƒ½
- **é•·æœŸè¨˜æ†¶ç³»çµ±**ï¼šå¯¦ç¾è·¨æœƒè©±çš„ç”¨æˆ¶è¨˜æ†¶å’Œåå¥½è¿½è¹¤
- **å€‹äººåŒ–å­¸ç¿’**ï¼šAIè‡ªå‹•å­¸ç¿’ç”¨æˆ¶çš„å…§å®¹åå¥½å’Œä½¿ç”¨ç¿’æ…£
- **æ™ºèƒ½æ‘˜è¦ç”Ÿæˆ**ï¼šè‡ªå‹•åˆ†é¡å’Œæ‘˜è¦å°è©±å…§å®¹
- **ç”¨æˆ¶è¡Œç‚ºåˆ†æ**ï¼šè¿½è¹¤å’Œåˆ†æç”¨æˆ¶çš„ä½¿ç”¨æ¨¡å¼
- **Google OAuthæ•´åˆ**ï¼šå®Œæ•´çš„ç”¨æˆ¶èªè­‰å’Œæˆæ¬Šç³»çµ±

#### ğŸ› ï¸ æŠ€è¡“ä¿®æ”¹
**æª”æ¡ˆï¼šapp.py**
- æ–°å¢è³‡æ–™åº«è¡¨ï¼š`user_preferences`ã€`user_behaviors`ã€`conversation_summaries`
- å¯¦ç¾æ™ºèƒ½å°è©±æ‘˜è¦ç®—æ³•ï¼š`generate_smart_summary()`
- æ–°å¢ç”¨æˆ¶åå¥½è¿½è¹¤ï¼š`track_user_preferences()`
- å¢å¼·ç”¨æˆ¶è¨˜æ†¶åŠŸèƒ½ï¼š`get_user_memory()`
- æ–°å¢APIç«¯é»ï¼š
  - `/api/user/memory/{user_id}` - ç²å–ç”¨æˆ¶è¨˜æ†¶
  - `/api/user/conversations/{user_id}` - ç²å–å°è©±è¨˜éŒ„
  - `/api/user/generations/{user_id}` - ç²å–ç”Ÿæˆè¨˜éŒ„
  - `/api/user/preferences/{user_id}` - ç²å–ç”¨æˆ¶åå¥½
  - `/api/user/behaviors/{user_id}` - ç²å–è¡Œç‚ºçµ±è¨ˆ
- æ•´åˆGoogle OAuthèªè­‰ç³»çµ±
- å¯¦ç¾ç”¨æˆ¶è³‡æ–™ç®¡ç†å’Œæœƒè©±ç®¡ç†

**æª”æ¡ˆï¼šrequirements.txt**
- æ–°å¢ `httpx` ä¾è³´å¥—ä»¶

**æª”æ¡ˆï¼šè³‡æ–™åº«çµæ§‹**
- æ“´å±• `user_profiles` è¡¨çµæ§‹
- æ–°å¢ `user_preferences` è¡¨ï¼šè¿½è¹¤ç”¨æˆ¶åå¥½å’Œä¿¡å¿ƒåˆ†æ•¸
- æ–°å¢ `user_behaviors` è¡¨ï¼šè¨˜éŒ„ç”¨æˆ¶è¡Œç‚ºæ•¸æ“š
- å„ªåŒ– `conversation_summaries` è¡¨ï¼šæ·»åŠ å°è©±é¡å‹åˆ†é¡

#### ğŸ¯ åŠŸèƒ½ç‰¹è‰²
1. **æ™ºèƒ½è¨˜æ†¶åˆ†é¡**ï¼š
   - å¸³è™Ÿå®šä½è¨è«–
   - é¸é¡Œè¨è«–
   - è…³æœ¬ç”Ÿæˆ
   - ä¸€èˆ¬è«®è©¢

2. **åå¥½å­¸ç¿’ç³»çµ±**ï¼š
   - å¹³å°åå¥½ï¼ˆæŠ–éŸ³ã€TikTokã€Instagramç­‰ï¼‰
   - å…§å®¹é¡å‹åå¥½ï¼ˆç¾é£Ÿã€æ—…éŠã€æ™‚å°šç­‰ï¼‰
   - é¢¨æ ¼åå¥½ï¼ˆæç¬‘ã€å°ˆæ¥­ã€æƒ…æ„Ÿç­‰ï¼‰
   - æ™‚é•·åå¥½ï¼ˆ15ç§’ã€30ç§’ã€60ç§’ï¼‰
   - ä¿¡å¿ƒåˆ†æ•¸è¿½è¹¤ï¼ˆ0.0-1.0ï¼‰

3. **å€‹äººåŒ–AIé¡§å•**ï¼š
   - åŸºæ–¼æ­·å²æ•¸æ“šçš„å€‹æ€§åŒ–å»ºè­°
   - ä¸Šä¸‹æ–‡é€£çºŒæ€§å°è©±
   - å°ˆæ¥­é ˜åŸŸå„ªåŒ–ï¼ˆçŸ­å½±éŸ³å‰µä½œï¼‰

#### ğŸ“Š è¶…è¶ŠGPTçš„è¨˜æ†¶èƒ½åŠ›
- âœ… æŒä¹…åŒ–è¨˜æ†¶ï¼ˆè·¨æœƒè©±ä¿å­˜ï¼‰
- âœ… å€‹äººåå¥½å­¸ç¿’
- âœ… ä¿¡å¿ƒåˆ†æ•¸è¿½è¹¤
- âœ… è¡Œç‚ºåˆ†æçµ±è¨ˆ
- âœ… å°ˆæ¥­é ˜åŸŸå„ªåŒ–
- âœ… åˆ†é¡è¨˜æ†¶ç®¡ç†

#### ğŸ¯ æ¸¬è©¦çµæœ
é•·æœŸè¨˜æ†¶åŠŸèƒ½é©—è­‰ï¼š
- âœ… ç”¨æˆ¶åå¥½è¿½è¹¤ï¼šæ­£å¸¸é‹ä½œ
- âœ… å°è©±æ‘˜è¦ç”Ÿæˆï¼šæ™ºèƒ½åˆ†é¡
- âœ… è·¨æœƒè©±è¨˜æ†¶ï¼šæŒä¹…åŒ–ä¿å­˜
- âœ… å€‹äººåŒ–å»ºè­°ï¼šåŸºæ–¼æ­·å²æ•¸æ“š
- âœ… APIç«¯é»ï¼šå…¨éƒ¨æ­£å¸¸éŸ¿æ‡‰

#### ğŸ“ ç¶“é©—ç¸½çµ
1. **å€‹äººåŒ–AIè¨­è¨ˆ**ï¼šå¯¦ç¾çœŸæ­£çš„å€‹äººåŒ–éœ€è¦å¤šç¶­åº¦æ•¸æ“šæ”¶é›†å’Œåˆ†æ
2. **ä¿¡å¿ƒåˆ†æ•¸ç³»çµ±**ï¼šé¿å…èª¤åˆ¤ç”¨æˆ¶åå¥½ï¼Œæä¾›æ›´ç²¾æº–çš„å­¸ç¿’
3. **åˆ†é¡è¨˜æ†¶ç®¡ç†**ï¼šæŒ‰åŠŸèƒ½åˆ†é¡çµ„ç¹”è¨˜æ†¶ï¼Œæé«˜æª¢ç´¢æ•ˆç‡
4. **å°ˆæ¥­é ˜åŸŸå„ªåŒ–**ï¼šé‡å°ç‰¹å®šé ˜åŸŸçš„AIæ¯”é€šç”¨AIæ›´æœ‰æ•ˆ

---

### 2025-10-20 - é‡å¤§ä¿®å¾©ï¼šè§£æ±ºéƒ¨ç½²å¾ŒAIç„¡æ³•å‘¼å«å•é¡Œ

#### ğŸš¨ å•é¡Œæè¿°
- **ç—‡ç‹€**ï¼šéƒ¨ç½²åˆ° Zeabur å¾Œï¼Œå‰ç«¯ç„¡æ³•å‘¼å« AIï¼Œå‡ºç¾ "Failed to fetch" éŒ¯èª¤
- **éŒ¯èª¤é¡å‹**ï¼š502 Bad Gateway éŒ¯èª¤
- **å½±éŸ¿ç¯„åœ**ï¼šå®Œå…¨ç„¡æ³•ä½¿ç”¨ AI åŠŸèƒ½

#### ğŸ” å•é¡Œè¨ºæ–·
1. **ç’°å¢ƒè®Šæ•¸é…ç½®æ­£ç¢º**ï¼šGEMINI_API_KEY ç­‰ç’°å¢ƒè®Šæ•¸å·²æ­£ç¢ºè¨­å®š
2. **æœå‹™ç‹€æ…‹ç•°å¸¸**ï¼šå¾Œç«¯æœå‹™é¡¯ç¤º RUNNING ä½†ç„¡æ³•éŸ¿æ‡‰è«‹æ±‚
3. **Uvicorn é…ç½®å•é¡Œ**ï¼šDockerfile å’Œ app.py çš„å•Ÿå‹•æ–¹å¼è¡çª

#### âœ… è§£æ±ºæ–¹æ¡ˆ
1. **ä¿®å¾© Uvicorn é…ç½®**ï¼š
   - çµ±ä¸€ Dockerfile å’Œ app.py çš„å•Ÿå‹•æ–¹å¼
   - ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ PORT é…ç½®
   - æ·»åŠ è©³ç´°çš„æ—¥èªŒè¨˜éŒ„

2. **æ”¹å–„éŒ¯èª¤è™•ç†**ï¼š
   - æ–°å¢å¥åº·æª¢æŸ¥ç«¯é»çš„ Gemini API æ¸¬è©¦åŠŸèƒ½
   - æä¾›è©³ç´°çš„è¨ºæ–·è³‡è¨Š
   - æ”¹å–„å‰ç«¯éŒ¯èª¤è¨Šæ¯é¡¯ç¤º

3. **å„ªåŒ–éƒ¨ç½²é…ç½®**ï¼š
   - ä¿®æ”¹ Dockerfile ä½¿ç”¨å‹•æ…‹ç«¯å£é…ç½®
   - æ·»åŠ å•Ÿå‹•æ—¥èªŒå’ŒéŒ¯èª¤è¿½è¹¤
   - ç¢ºä¿æœå‹™æ­£ç¢ºå•Ÿå‹•å’ŒéŸ¿æ‡‰

#### ğŸ› ï¸ æŠ€è¡“ä¿®æ”¹
**æª”æ¡ˆï¼šapp.py**
- æ–°å¢ Gemini API é€£ç·šæ¸¬è©¦åŠŸèƒ½
- æ”¹å–„å¥åº·æª¢æŸ¥å›æ‡‰
- æ·»åŠ è©³ç´°çš„å•Ÿå‹•æ—¥èªŒ

**æª”æ¡ˆï¼šDockerfile**
- ä¿®æ”¹å•Ÿå‹•å‘½ä»¤ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ PORT
- æ·»åŠ æ—¥èªŒç´šåˆ¥é…ç½®

**æª”æ¡ˆï¼šindex.html**
- æ–°å¢ã€ŒğŸ”§ æ¸¬è©¦é€£ç·šã€æŒ‰éˆ•
- æ”¹å–„éŒ¯èª¤è™•ç†å’Œè¨ºæ–·åŠŸèƒ½
- ä¿®æ­£ API ç«¯é»é…ç½®

#### ğŸ¯ æ¸¬è©¦çµæœ
ä¿®å¾©å¾Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼š
- âœ… å¾Œç«¯æ ¹è·¯å¾‘ï¼šæ­£å¸¸ (ç‹€æ…‹ç¢¼:200)
- âœ… å¥åº·æª¢æŸ¥ï¼šæ­£å¸¸
- âœ… Geminié…ç½®ï¼šå·²é…ç½®
- âœ… Geminiæ¸¬è©¦ï¼šworking
- âœ… èŠå¤©APIï¼šæ­£å¸¸ (ç‹€æ…‹ç¢¼:200)

#### ğŸ“ ç¶“é©—ç¸½çµ
1. **éƒ¨ç½²å•é¡Œè¨ºæ–·**ï¼šä½¿ç”¨å¥åº·æª¢æŸ¥ç«¯é»å’Œè©³ç´°æ—¥èªŒ
2. **é…ç½®ä¸€è‡´æ€§**ï¼šç¢ºä¿ Dockerfile å’Œæ‡‰ç”¨ç¨‹å¼é…ç½®ä¸€è‡´
3. **éŒ¯èª¤è™•ç†**ï¼šæä¾›æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯å’Œè¨ºæ–·å·¥å…·
4. **æ¸¬è©¦å·¥å…·**ï¼šå‰ç«¯æ•´åˆæ¸¬è©¦åŠŸèƒ½ä¾¿æ–¼å•é¡Œè¨ºæ–·

---

### 2025-10-21 - é›™å±¤è¨˜æ†¶ç³»çµ±æ•´åˆèˆ‡ä¸€éµç”ŸæˆåŠŸèƒ½

#### ğŸš€ æ–°å¢åŠŸèƒ½
1. **çŸ­æœŸè¨˜æ†¶ï¼ˆSTMï¼‰ç³»çµ±**ï¼š
   - è¨˜æ†¶é«”å…§è¨˜æ†¶å„²å­˜ï¼Œæ”¯æ´48å°æ™‚TTL
   - è‡ªå‹•å°è©±å£“ç¸®ï¼šè¶…é20è¼ªå°è©±è‡ªå‹•æ‘˜è¦å£“ç¸®
   - ç‚ºæ¯å€‹ç”¨æˆ¶ç¶­è­·æœ€è¿‘çš„å°è©±ä¸Šä¸‹æ–‡
   - æ”¯æ´è¨˜æ†¶æ¸…é™¤å’Œé‡ç½®

2. **é•·æœŸè¨˜æ†¶ï¼ˆLTMï¼‰å¢å¼·**ï¼š
   - æ™ºèƒ½å°è©±åˆ†é¡ï¼šå®šä½é¡ã€é¸é¡Œé¡ã€è…³æœ¬é¡ã€è«®è©¢é¡ã€å…¶ä»–
   - é—œéµè©è‡ªå‹•æå–
   - ç”¨æˆ¶åå¥½è¿½è¹¤ï¼šå¹³å°ã€å…§å®¹é¡å‹ã€é¢¨æ ¼ã€æ™‚é•·ã€ä¿¡å¿ƒåˆ†æ•¸
   - ç”¨æˆ¶è¡Œç‚ºæ—¥èªŒè¨˜éŒ„

3. **ä¸€éµç”ŸæˆåŠŸèƒ½**ï¼š
   - **ä¸€éµç”Ÿæˆå¸³è™Ÿå®šä½**ï¼šåŸºæ–¼ç”¨æˆ¶éœ€æ±‚è¨­å®šï¼Œè‡ªå‹•åˆ†æç›®æ¨™å—çœ¾ã€å…§å®¹æ–¹å‘ã€é¢¨æ ¼èª¿æ€§
   - **ä¸€éµç”Ÿæˆè…³æœ¬é¸é¡Œ**ï¼šæ ¹æ“šå¸³è™Ÿå®šä½ï¼Œæ¨è–¦3-5å€‹å…·é«”é¸é¡Œæ–¹å‘
   - **ä¸€éµç”ŸæˆçŸ­å½±éŸ³è…³æœ¬**ï¼šå®Œæ•´è…³æœ¬ç”Ÿæˆï¼ŒåŒ…å«Hookã€Valueã€CTAçµæ§‹
   - éšæ®µæ€§é©—è­‰ï¼šå¿…é ˆå…ˆå®Œæˆå¸³è™Ÿå®šä½æ‰èƒ½é¸é¡Œï¼Œå…ˆå®Œæˆé¸é¡Œæ‰èƒ½ç”Ÿæˆè…³æœ¬

4. **AIæç¤ºè©å„ªåŒ–**ï¼š
   - å°‡AIè§’è‰²å¾"çŸ­å½±éŸ³è…³æœ¬èˆ‡æ–‡æ¡ˆåŠ©ç†"å‡ç´šç‚º"AIJobçŸ­å½±éŸ³é¡§å•"
   - æ–°å¢å°ˆæ¥­é¡§å•æµç¨‹ï¼šå¸³è™Ÿå®šä½ â†’ é¸é¡Œç­–ç•¥ â†’ è…³æœ¬ç”Ÿæˆ
   - å¼·åŒ–å°è©±è¨˜æ†¶æª¢æŸ¥æ¸…å–®ï¼Œé¿å…é‡è¤‡æå•
   - å„ªåŒ–å›æ‡‰æ ¼å¼ï¼šç¦æ­¢Markdownï¼Œä½¿ç”¨emojiå’Œåˆ—é»çµ„ç¹”å…§å®¹

5. **è³‡æ–™åº«çµæ§‹å„ªåŒ–**ï¼š
   - `conversation_summaries` è¡¨æ–°å¢ `conversation_type` å’Œ `keywords` æ¬„ä½
   - æ–°å¢ `user_preferences` è¡¨ï¼šè¿½è¹¤ç”¨æˆ¶å…§å®¹åå¥½
   - æ–°å¢ `user_behaviors` è¡¨ï¼šè¨˜éŒ„ç”¨æˆ¶è¡Œç‚ºæ—¥èªŒ

#### ğŸ› ï¸ æŠ€è¡“ä¿®æ”¹

**æª”æ¡ˆï¼šapp.py**
- æ–°å¢è¨˜æ†¶ç³»çµ±æ•´åˆï¼š
  - å°å…¥ `memory.py` å’Œ `prompt_builder.py` æ¨¡çµ„
  - ä¿®æ”¹ `/api/chat/stream` ç«¯é»ï¼Œæ•´åˆSTMå’ŒLTM
  - ä½¿ç”¨ `build_enhanced_prompt()` å‡½æ•¸çµ„åˆç³»çµ±æç¤ºè©ã€STMä¸Šä¸‹æ–‡ã€LTMè¨˜æ†¶
  - åœ¨å°è©±çµæŸå¾Œè‡ªå‹•ä¿å­˜åˆ°STMå’ŒLTM

- æ–°å¢ä¸€éµç”ŸæˆAPIç«¯é»ï¼š
  - `POST /api/generate/positioning`ï¼šä¸€éµç”Ÿæˆå¸³è™Ÿå®šä½
  - `POST /api/generate/topics`ï¼šä¸€éµç”Ÿæˆè…³æœ¬é¸é¡Œ
  - `POST /api/generate/script`ï¼šä¸€éµç”ŸæˆçŸ­å½±éŸ³è…³æœ¬
  - æ¯å€‹ç«¯é»éƒ½æœ‰å°ˆé–€çš„AIæç¤ºè©ï¼Œç¢ºä¿è¼¸å‡ºå“è³ª

- æ–°å¢è¨˜æ†¶ç®¡ç†APIç«¯é»ï¼š
  - `GET /api/user/stm/{user_id}`ï¼šç²å–ç”¨æˆ¶çŸ­æœŸè¨˜æ†¶
  - `DELETE /api/user/stm/{user_id}`ï¼šæ¸…é™¤ç”¨æˆ¶çŸ­æœŸè¨˜æ†¶
  - `GET /api/user/memory/full/{user_id}`ï¼šç²å–å®Œæ•´è¨˜æ†¶ï¼ˆSTM + LTMï¼‰
  - `GET /api/user/preferences/{user_id}`ï¼šç²å–ç”¨æˆ¶åå¥½
  - `GET /api/user/behaviors/{user_id}`ï¼šç²å–ç”¨æˆ¶è¡Œç‚ºæ—¥èªŒ

- ä¿®æ”¹ `build_system_prompt()` å‡½æ•¸ï¼š
  - æ˜ç¢ºAIè§’è‰²ç‚º"AIJobçŸ­å½±éŸ³é¡§å•"
  - æ–°å¢æ ¸å¿ƒåŸå‰‡ï¼šæª¢æŸ¥å°è©±æ­·å²ã€åŸºæ–¼å·²æœ‰ä¿¡æ¯ã€æ¨é€²å°è©±ã€è¨˜ä½æµç¨‹ä½ç½®ã€é¿å…é‡è¤‡å•å€™
  - æ–°å¢å°ˆæ¥­é¡§å•æµç¨‹å’Œå°è©±è¨˜æ†¶æª¢æŸ¥æ¸…å–®
  - å¼·åŒ–å…§å®¹æ ¼å¼è¦æ±‚ï¼šç¦æ­¢ä½¿ç”¨Markdownç¬¦è™Ÿ

- æ–°å¢æ™ºèƒ½æ‘˜è¦ç”Ÿæˆå‡½æ•¸ï¼š
  - `generate_smart_summary()`ï¼šç”Ÿæˆæ™ºèƒ½å°è©±æ‘˜è¦
  - `extract_keywords()`ï¼šæå–å°è©±é—œéµè©
  - `classify_conversation()`ï¼šåˆ†é¡å°è©±é¡å‹

- æ–°å¢ç”¨æˆ¶åå¥½è¿½è¹¤å‡½æ•¸ï¼š
  - `track_user_preferences()`ï¼šè¿½è¹¤å’Œæ›´æ–°ç”¨æˆ¶åå¥½
  - `extract_user_preferences()`ï¼šå¾å°è©±ä¸­æå–ç”¨æˆ¶åå¥½

- ä¿®æ”¹è³‡æ–™åº«åˆå§‹åŒ–ï¼š
  - æ›´æ–° `conversation_summaries` è¡¨çµæ§‹
  - æ–°å¢ `user_preferences` å’Œ `user_behaviors` è¡¨

- ä¿®æ”¹æœ¬åœ°å•Ÿå‹•åŸ è™Ÿï¼šå¾3000æ”¹ç‚º8000

**æ–°æª”æ¡ˆï¼šmemory.py**
- å¯¦ç¾çŸ­æœŸè¨˜æ†¶ï¼ˆSTMï¼‰ç®¡ç†ç³»çµ±
- ä¸»è¦åŠŸèƒ½ï¼š
  - `load_memory()`ï¼šè¼‰å…¥ç”¨æˆ¶è¨˜æ†¶
  - `save_memory()`ï¼šä¿å­˜ç”¨æˆ¶è¨˜æ†¶
  - `add_turn()`ï¼šæ·»åŠ å°è©±è¼ªæ¬¡
  - `get_context_for_prompt()`ï¼šç²å–è¨˜æ†¶ä¸Šä¸‹æ–‡ä¾›LLMä½¿ç”¨
  - `get_recent_turns_for_history()`ï¼šç²å–æœ€è¿‘å°è©±æ­·å²
  - `clear_memory()`ï¼šæ¸…é™¤ç”¨æˆ¶è¨˜æ†¶
- è‡ªå‹•å£“ç¸®æ©Ÿåˆ¶ï¼šè¶…é20è¼ªå°è©±è‡ªå‹•æ‘˜è¦
- 48å°æ™‚TTLæ©Ÿåˆ¶

**æ–°æª”æ¡ˆï¼šprompt_builder.py**
- å¯¦ç¾å¢å¼·ç‰ˆç³»çµ±æç¤ºè©æ§‹å»º
- ä¸»è¦åŠŸèƒ½ï¼š
  - `build_enhanced_prompt()`ï¼šæ•´åˆçŸ¥è­˜åº«ã€STMã€LTMæ§‹å»ºå®Œæ•´æç¤ºè©
  - `format_memory_for_display()`ï¼šæ ¼å¼åŒ–è¨˜æ†¶æ•¸æ“šä¾›å‰ç«¯é¡¯ç¤º
- çµ„åˆæ ¼å¼ï¼šç³»çµ±è¦å‰‡ â†’ ç”¨æˆ¶è¨­å®š â†’ STMä¸Šä¸‹æ–‡ â†’ LTMè¨˜æ†¶ â†’ çŸ¥è­˜åº«

**æª”æ¡ˆï¼šrequirements.txt**
- ç¶­æŒç¾æœ‰ä¾è³´ï¼ˆç„¡æ–°å¢ï¼‰

#### ğŸ¯ æ¸¬è©¦çµæœ

ä¿®å¾©å¾Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼š
- âœ… **STMç³»çµ±**ï¼šæˆåŠŸè¨˜éŒ„å’Œæª¢ç´¢æœ€è¿‘å°è©±
- âœ… **LTMç³»çµ±**ï¼šæ™ºèƒ½åˆ†é¡å’Œæ‘˜è¦ç”Ÿæˆ
- âœ… **ç”¨æˆ¶åå¥½è¿½è¹¤**ï¼šè‡ªå‹•å­¸ç¿’ç”¨æˆ¶å–œå¥½
- âœ… **ä¸€éµç”Ÿæˆå¸³è™Ÿå®šä½**ï¼šåŸºæ–¼è¨­å®šç”Ÿæˆå°ˆæ¥­å»ºè­°
- âœ… **ä¸€éµç”Ÿæˆé¸é¡Œ**ï¼šæ ¹æ“šå®šä½æ¨è–¦å…·é«”é¸é¡Œ
- âœ… **ä¸€éµç”Ÿæˆè…³æœ¬**ï¼šå®Œæ•´çš„çŸ­å½±éŸ³è…³æœ¬è¼¸å‡º
- âœ… **éšæ®µæ€§é©—è­‰**ï¼šç¢ºä¿æŒ‰æ­£ç¢ºé †åºç”Ÿæˆå…§å®¹
- âœ… **AIå°è©±**ï¼šè¨˜æ†¶é€£è²«ï¼Œä¸é‡è¤‡æå•
- âœ… **è¨˜æ†¶API**ï¼šæ‰€æœ‰ç«¯é»æ­£å¸¸éŸ¿æ‡‰
- âœ… **è³‡æ–™åº«**ï¼šæ–°çµæ§‹æ­£ç¢ºå‰µå»ºå’Œä½¿ç”¨

#### ğŸ”§ å•é¡Œä¿®å¾©

1. **è³‡æ–™åº«çµæ§‹éèˆŠå•é¡Œ**ï¼š
   - **ç—‡ç‹€**ï¼š`no such column: conversation_type` éŒ¯èª¤
   - **åŸå› **ï¼šèˆŠè³‡æ–™åº«ç¼ºå°‘æ–°å¢çš„æ¬„ä½
   - **è§£æ±º**ï¼šå‚™ä»½èˆŠè³‡æ–™åº«ï¼ˆ`chatbot.db.backup`ï¼‰ï¼Œé‡å»ºæ–°è³‡æ–™åº«

2. **API Key ç’°å¢ƒè®Šæ•¸å•é¡Œ**ï¼š
   - **ç—‡ç‹€**ï¼šèƒŒæ™¯åŸ·è¡Œæ™‚ `GEMINI_API_KEY` æœªå‚³é
   - **åŸå› **ï¼šèƒŒæ™¯é€²ç¨‹æœªç¹¼æ‰¿ç’°å¢ƒè®Šæ•¸
   - **è§£æ±º**ï¼šåœ¨å•Ÿå‹•å‘½ä»¤ä¸­æ˜ç¢º `export GEMINI_API_KEY`

3. **åŸ è™Ÿä¸ä¸€è‡´å•é¡Œ**ï¼š
   - **ç—‡ç‹€**ï¼šå¾Œç«¯å•Ÿå‹•åœ¨3000åŸ ï¼Œå‰ç«¯å˜—è©¦é€£æ¥8000åŸ 
   - **åŸå› **ï¼šæœ¬åœ°é–‹ç™¼æ™‚åŸ è™Ÿè¨­å®šä¸ä¸€è‡´
   - **è§£æ±º**ï¼šçµ±ä¸€ä½¿ç”¨8000åŸ 

4. **ä¸€éµç”Ÿæˆç¼ºå°‘messageæ¬„ä½**ï¼š
   - **ç—‡ç‹€**ï¼š422éŒ¯èª¤ï¼Œ`Field required: message`
   - **åŸå› **ï¼šå‰ç«¯æœªå‚³éå¿…è¦çš„ `message` æ¬„ä½
   - **è§£æ±º**ï¼šå‰ç«¯ä¸€éµç”Ÿæˆå‡½æ•¸æ–°å¢ `message` æ¬„ä½

5. **APIç«¯é»å®šç¾©é †åºå•é¡Œ**ï¼š
   - **ç—‡ç‹€**ï¼š`NameError: name 'app' is not defined`
   - **åŸå› **ï¼šAPIç«¯é»åœ¨ `app = FastAPI()` ä¹‹å‰å®šç¾©
   - **è§£æ±º**ï¼šç§»å‹•æ‰€æœ‰APIç«¯é»å®šç¾©åˆ° `app` åˆå§‹åŒ–ä¹‹å¾Œ

#### ğŸ“ ç¶“é©—ç¸½çµ

1. **è¨˜æ†¶ç³»çµ±è¨­è¨ˆ**ï¼š
   - çŸ­æœŸè¨˜æ†¶ç”¨æ–¼ç¶­æŒå°è©±é€£è²«æ€§
   - é•·æœŸè¨˜æ†¶ç”¨æ–¼å€‹äººåŒ–å­¸ç¿’
   - é›™å±¤æ¶æ§‹æä¾›æœ€ä½³æ•ˆèƒ½å’Œé«”é©—

2. **è³‡æ–™åº«é·ç§»**ï¼š
   - çµæ§‹è®Šæ›´æ™‚éœ€è¦é‡å»ºè³‡æ–™åº«
   - å‹™å¿…å‚™ä»½èˆŠè³‡æ–™
   - è€ƒæ…®å¯¦ç¾è³‡æ–™é·ç§»è…³æœ¬

3. **èƒŒæ™¯é€²ç¨‹ç®¡ç†**ï¼š
   - ç’°å¢ƒè®Šæ•¸éœ€è¦æ˜ç¢ºå‚³é
   - ä½¿ç”¨ `tee` åŒæ™‚è¼¸å‡ºåˆ°çµ‚ç«¯å’Œæ—¥èªŒæª”æ¡ˆ
   - ä½¿ç”¨ `pkill` ç¢ºä¿èˆŠé€²ç¨‹å®Œå…¨åœæ­¢

4. **APIè¨­è¨ˆåŸå‰‡**ï¼š
   - ä¸€éµç”Ÿæˆèˆ‡å°è©±èŠå¤©ä½¿ç”¨ä¸åŒæç¤ºè©
   - éšæ®µæ€§é©—è­‰ç¢ºä¿å…§å®¹å“è³ª
   - æ‰€æœ‰ç«¯é»éƒ½è¦æ”¯æ´ä¸²æµè¼¸å‡º

5. **AIæç¤ºè©å·¥ç¨‹**ï¼š
   - æ˜ç¢ºçš„è§’è‰²å®šä½å’Œæµç¨‹æŒ‡å¼•
   - é¿å…éåº¦æŒ‡å°ï¼Œä¿æŒå½ˆæ€§
   - å¼·åŒ–è¨˜æ†¶æª¢æŸ¥ï¼Œé¿å…é‡è¤‡æå•

#### ğŸš€ æœ¬åœ°é–‹ç™¼å•Ÿå‹•æŒ‡ä»¤

**æ¨è–¦æ–¹å¼ï¼ˆèƒŒæ™¯åŸ·è¡Œ + æ—¥èªŒè¼¸å‡ºï¼‰**ï¼š
```bash
# 1. åœæ­¢èˆŠé€²ç¨‹
pkill -9 -f "python.*app.py"

# 2. å•Ÿå‹•å¾Œç«¯æœå‹™ï¼ˆèƒŒæ™¯åŸ·è¡Œ + æ—¥èªŒï¼‰
cd /Users/user/Downloads/ai_web_app/å°è©±å¼/chatbot/backend
source venv/bin/activate
export GEMINI_API_KEY="AIzaSyCNmsgpPxo6acx3TVlVrvMLWOvqqj38TR4"
python app.py 2>&1 | tee /tmp/backend.log &

# 3. æŸ¥çœ‹å³æ™‚æ—¥èªŒ
tail -f /tmp/backend.log
```

**å‰å°åŸ·è¡Œæ–¹å¼ï¼ˆå¯çœ‹åˆ°å³æ™‚è¼¸å‡ºï¼‰**ï¼š
```bash
cd /Users/user/Downloads/ai_web_app/å°è©±å¼/chatbot/backend
source venv/bin/activate
export GEMINI_API_KEY="AIzaSyCNmsgpPxo6acx3TVlVrvMLWOvqqj38TR4"
python app.py
```

#### ğŸ“Š è¨˜æ†¶ç³»çµ±æ¶æ§‹

```
çŸ­æœŸè¨˜æ†¶ï¼ˆSTMï¼‰- memory.py
â”œâ”€â”€ å„²å­˜æ–¹å¼ï¼šè¨˜æ†¶é«”å­—å…¸
â”œâ”€â”€ TTLï¼š48å°æ™‚è‡ªå‹•éæœŸ
â”œâ”€â”€ å®¹é‡ï¼šæœ€è¿‘20è¼ªå°è©±
â””â”€â”€ è‡ªå‹•å£“ç¸®ï¼šè¶…éé–¾å€¼è‡ªå‹•æ‘˜è¦

é•·æœŸè¨˜æ†¶ï¼ˆLTMï¼‰- app.py
â”œâ”€â”€ å„²å­˜æ–¹å¼ï¼šSQLiteè³‡æ–™åº«
â”œâ”€â”€ å°è©±æ‘˜è¦ï¼šconversation_summariesè¡¨
â”œâ”€â”€ ç”¨æˆ¶åå¥½ï¼šuser_preferencesè¡¨
â””â”€â”€ è¡Œç‚ºæ—¥èªŒï¼šuser_behaviorsè¡¨

æç¤ºè©æ§‹å»º - prompt_builder.py
â””â”€â”€ æ•´åˆé †åºï¼šç³»çµ±è¦å‰‡ â†’ ç”¨æˆ¶è¨­å®š â†’ STM â†’ LTM â†’ çŸ¥è­˜åº«
```

#### ğŸ¯ ä¸€éµç”Ÿæˆæµç¨‹

```
1. å¸³è™Ÿå®šä½
   â”œâ”€â”€ è¼¸å…¥ï¼šå¹³å°ã€ä¸»é¡Œã€å—çœ¾ï¼ˆé¸å¡«ï¼‰
   â”œâ”€â”€ åˆ†æï¼šç›®æ¨™å—çœ¾ã€å…§å®¹æ–¹å‘ã€é¢¨æ ¼èª¿æ€§
   â””â”€â”€ è¼¸å‡ºï¼šğŸ“Œ å®šä½å»ºè­°

2. è…³æœ¬é¸é¡Œ
   â”œâ”€â”€ å‰ç½®æ¢ä»¶ï¼šå¿…é ˆå…ˆå®Œæˆå¸³è™Ÿå®šä½
   â”œâ”€â”€ è¼¸å…¥ï¼šåŸºæ–¼å¸³è™Ÿå®šä½çµæœ
   â”œâ”€â”€ åˆ†æï¼šé¸é¡Œæ–¹å‘ã€å…§å®¹è§’åº¦ã€è©±é¡Œç†±åº¦
   â””â”€â”€ è¼¸å‡ºï¼šğŸ’¡ 3-5å€‹é¸é¡Œå»ºè­°

3. çŸ­å½±éŸ³è…³æœ¬
   â”œâ”€â”€ å‰ç½®æ¢ä»¶ï¼šå¿…é ˆå…ˆå®Œæˆé¸é¡Œ
   â”œâ”€â”€ è¼¸å…¥ï¼šåŸºæ–¼é¸é¡Œçµæœ + ç”¨æˆ¶è¨­å®š
   â”œâ”€â”€ ç”Ÿæˆï¼šä¸»é¡Œæ¨™é¡Œã€è…³æœ¬å…§å®¹ã€ç•«é¢æ„Ÿã€ç™¼ä½ˆæ–‡æ¡ˆ
   â””â”€â”€ è¼¸å‡ºï¼šğŸ“ å®Œæ•´è…³æœ¬
```

---

## ğŸ“ æ›´æ–°æ—¥èªŒæ ¼å¼æŒ‡å—

### ç‚ºä¸‹ä¸€å€‹ AI åŠ©ç†çš„èªªæ˜
ç•¶æœ‰é‡å¤§æ›´æ–°ã€å•é¡Œä¿®å¾©æˆ–æ–°åŠŸèƒ½æ™‚ï¼Œè«‹åœ¨ã€Œæ›´æ–°æ—¥èªŒã€å€æ®µæ·»åŠ æ–°çš„è¨˜éŒ„ã€‚ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

```markdown
### YYYY-MM-DD - æ›´æ–°æ¨™é¡Œ

#### ğŸš¨ å•é¡Œæè¿°ï¼ˆå¦‚æœæ˜¯ä¿®å¾©å•é¡Œï¼‰
- **ç—‡ç‹€**ï¼šå…·é«”çš„éŒ¯èª¤ç¾è±¡
- **éŒ¯èª¤é¡å‹**ï¼šéŒ¯èª¤ä»£ç¢¼æˆ–é¡å‹
- **å½±éŸ¿ç¯„åœ**ï¼šå—å½±éŸ¿çš„åŠŸèƒ½æˆ–ç”¨æˆ¶

#### ğŸ” å•é¡Œè¨ºæ–·ï¼ˆå¦‚æœæ˜¯ä¿®å¾©å•é¡Œï¼‰
1. **æ­¥é©Ÿ1**ï¼šè¨ºæ–·éç¨‹
2. **æ­¥é©Ÿ2**ï¼šç™¼ç¾çš„å•é¡Œ
3. **æ­¥é©Ÿ3**ï¼šæ ¹æœ¬åŸå› åˆ†æ

#### âœ… è§£æ±ºæ–¹æ¡ˆ/æ–°å¢åŠŸèƒ½
1. **è§£æ±ºæ–¹æ¡ˆ1**ï¼šå…·é«”çš„ä¿®å¾©æ­¥é©Ÿ
2. **è§£æ±ºæ–¹æ¡ˆ2**ï¼šç›¸é—œçš„é…ç½®èª¿æ•´
3. **è§£æ±ºæ–¹æ¡ˆ3**ï¼šé é˜²æªæ–½

#### ğŸ› ï¸ æŠ€è¡“ä¿®æ”¹
**æª”æ¡ˆï¼šæª”æ¡ˆåç¨±**
- å…·é«”ä¿®æ”¹å…§å®¹1
- å…·é«”ä¿®æ”¹å…§å®¹2

**æª”æ¡ˆï¼šå¦ä¸€å€‹æª”æ¡ˆåç¨±**
- ä¿®æ”¹å…§å®¹æè¿°

#### ğŸ¯ æ¸¬è©¦çµæœ
ä¿®å¾©/æ–°å¢å¾Œçš„åŠŸèƒ½é©—è­‰ï¼š
- âœ… åŠŸèƒ½1ï¼šæ¸¬è©¦çµæœ
- âœ… åŠŸèƒ½2ï¼šæ¸¬è©¦çµæœ
- âŒ åŠŸèƒ½3ï¼šå·²çŸ¥å•é¡Œï¼ˆå¦‚æœ‰ï¼‰

#### ğŸ“ ç¶“é©—ç¸½çµ
1. **æŠ€è¡“è¦é»**ï¼šé‡è¦çš„æŠ€è¡“ç¶“é©—
2. **æœ€ä½³å¯¦è¸**ï¼šæ¨è–¦çš„åšæ³•
3. **æ³¨æ„äº‹é …**ï¼šéœ€è¦ç‰¹åˆ¥æ³¨æ„çš„åœ°æ–¹
```

### ğŸ“‹ æ›´æ–°æ—¥èªŒæ’°å¯«è¦é»
- **è©³ç´°è¨˜éŒ„**ï¼šåŒ…å«è¶³å¤ çš„æŠ€è¡“ç´°ç¯€ï¼Œä¾¿æ–¼æœªä¾†åƒè€ƒ
- **å•é¡Œè¨ºæ–·**ï¼šè¨˜éŒ„å®Œæ•´çš„å•é¡Œåˆ†æéç¨‹
- **è§£æ±ºæ­¥é©Ÿ**ï¼šæä¾›å¯é‡ç¾çš„ä¿®å¾©æ­¥é©Ÿ
- **æ¸¬è©¦é©—è­‰**ï¼šè¨˜éŒ„ä¿®å¾©å¾Œçš„æ¸¬è©¦çµæœ
- **ç¶“é©—æç…‰**ï¼šç¸½çµé‡è¦çš„æŠ€è¡“ç¶“é©—å’Œæœ€ä½³å¯¦è¸

---

## ğŸ†• è…³æœ¬å„²å­˜ç³»çµ± (2025-10-21)

### ğŸ“‹ æ–°å¢åŠŸèƒ½

#### 1. è…³æœ¬å„²å­˜ API
- **POST** `/api/scripts/save` - å„²å­˜è…³æœ¬
- **GET** `/api/scripts/my` - ç²å–ç”¨æˆ¶è…³æœ¬åˆ—è¡¨
- **PUT** `/api/scripts/{id}/name` - æ›´æ–°è…³æœ¬åç¨±
- **DELETE** `/api/scripts/{id}` - åˆªé™¤è…³æœ¬

#### 2. ç®¡ç†å“¡ API
- **GET** `/api/admin/users` - ç²å–æ‰€æœ‰ç”¨æˆ¶è³‡æ–™
- **GET** `/api/admin/user/{id}/data` - ç²å–æŒ‡å®šç”¨æˆ¶å®Œæ•´è³‡æ–™
- **GET** `/api/admin/statistics` - ç²å–ç³»çµ±çµ±è¨ˆè³‡æ–™

#### 3. è³‡æ–™åº«è¡¨æ ¼
```sql
CREATE TABLE user_scripts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT NOT NULL,
    script_name TEXT,
    title TEXT,
    content TEXT NOT NULL,
    script_data TEXT,
    platform TEXT,
    topic TEXT,
    profile TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user_profiles (user_id)
);
```

### ğŸ”§ æŠ€è¡“å¯¦ç¾

#### 1. è³‡æ–™åº«é€£æ¥å„ªåŒ–
```python
def get_db_connection():
    conn = sqlite3.connect(db_path, timeout=30.0)
    conn.execute("PRAGMA journal_mode=WAL")
    conn.execute("PRAGMA synchronous=NORMAL")
    return conn
```

#### 2. è…³æœ¬å„²å­˜é‡è©¦æ©Ÿåˆ¶
```python
max_retries = 3
retry_count = 0
while retry_count < max_retries:
    try:
        # å„²å­˜é‚è¼¯
        break
    except sqlite3.OperationalError as e:
        if "database is locked" in str(e):
            retry_count += 1
            await asyncio.sleep(0.1 * retry_count)
```

#### 3. è…³æœ¬æ•¸æ“šçµæ§‹
```python
script_data = {
    "title": "è…³æœ¬æ¨™é¡Œ",
    "overview": "è…³æœ¬æ¦‚è¦½",
    "sections": [
        {
            "type": "Hook/Value/CTA",
            "content": ["å…§å®¹1", "å…§å®¹2"]
        }
    ]
}
```

### âš ï¸ å·²çŸ¥å•é¡Œ

#### 1. APIèªè­‰å•é¡Œ
- **ç¾è±¡**ï¼š401 Unauthorized éŒ¯èª¤
- **åŸå› **ï¼š`get_current_user` å‡½æ•¸èªè­‰å¤±æ•—
- **å½±éŸ¿**ï¼šè…³æœ¬å„²å­˜ã€è¼‰å…¥ã€ç®¡ç†åŠŸèƒ½ç„¡æ³•ä½¿ç”¨

#### 2. è³‡æ–™åº«é–å®šå•é¡Œ
- **ç¾è±¡**ï¼š`database is locked` éŒ¯èª¤
- **åŸå› **ï¼šå¤šå€‹è«‹æ±‚åŒæ™‚è¨ªå•SQLite
- **å½±éŸ¿**ï¼šå¶çˆ¾å°è‡´æ“ä½œå¤±æ•—

#### 3. è³‡æ–™æŒä¹…åŒ–å•é¡Œ
- **ç¾è±¡**ï¼šZeaburé‡æ–°éƒ¨ç½²æ™‚è³‡æ–™éºå¤±
- **åŸå› **ï¼šSQLiteä¸é©åˆç”Ÿç”¢ç’°å¢ƒ
- **å½±éŸ¿**ï¼šæ‰€æœ‰ç”¨æˆ¶è³‡æ–™æœƒéºå¤±

### ğŸ¯ å¾…ä¿®å¾©é …ç›®

1. **ä¿®å¾©APIèªè­‰**ï¼š
   - æª¢æŸ¥ `get_current_user` å‡½æ•¸
   - ç¢ºä¿JWT tokenæ­£ç¢ºè§£æ
   - ä¿®å¾©èªè­‰é‚è¼¯

2. **å„ªåŒ–è³‡æ–™åº«é€£æ¥**ï¼š
   - å¯¦ç¾é€£æ¥æ± 
   - æ·»åŠ æ›´å¥½çš„é–å®šè™•ç†
   - è€ƒæ…®å‡ç´šåˆ°PostgreSQL

3. **å®Œå–„éŒ¯èª¤è™•ç†**ï¼š
   - æ·»åŠ æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
   - å¯¦ç¾æ›´å¥½çš„é‡è©¦æ©Ÿåˆ¶
   - æ·»åŠ æ—¥èªŒè¨˜éŒ„

---

## ğŸ”§ 2025-10-21 ä¿®å¾©è¨˜éŒ„

### è…³æœ¬å„²å­˜ç³»çµ±ä¿®å¾©

#### å•é¡Œæè¿°
- å‰ç«¯è…³æœ¬å„²å­˜æˆåŠŸä½†ã€Œæˆ‘çš„è…³æœ¬ã€ä¸é¡¯ç¤º
- å¾Œç«¯APIèªè­‰å•é¡Œå°è‡´ 401 éŒ¯èª¤
- ç”¨æˆ¶ç„¡æ³•æŸ¥çœ‹å·²å„²å­˜çš„è…³æœ¬

#### ä¿®å¾©æªæ–½

1. **å‰ç«¯æœ¬åœ°å„²å­˜å‚™æ¡ˆ**ï¼š
   - æ·»åŠ  `localStorage` ä½œç‚ºå¾Œç«¯APIçš„å‚™æ¡ˆæ©Ÿåˆ¶
   - å¯¦ç¾ `getLocalScripts()` å’Œ `saveScriptToLocal()` å‡½æ•¸
   - ç•¶å¾Œç«¯APIä¸å¯ç”¨æ™‚è‡ªå‹•ä½¿ç”¨æœ¬åœ°å„²å­˜

2. **éŒ¯èª¤è™•ç†å„ªåŒ–**ï¼š
   - 401 èªè­‰éŒ¯èª¤ï¼šé¡¯ç¤ºç™»å…¥æç¤º
   - 404 APIä¸å­˜åœ¨ï¼šè‡ªå‹•ä½¿ç”¨æœ¬åœ°å„²å­˜
   - ç¶²è·¯éŒ¯èª¤ï¼šè‡ªå‹•ä½¿ç”¨æœ¬åœ°å„²å­˜

3. **èª¿è©¦æ—¥èªŒå¢å¼·**ï¼š
   - æ·»åŠ è©³ç´°çš„æ§åˆ¶å°æ—¥èªŒ
   - ä¾¿æ–¼å•é¡Œæ’æŸ¥å’Œç‹€æ…‹è¿½è¹¤

#### æŠ€è¡“å¯¦ç¾

**å‰ç«¯ä¿®æ”¹**ï¼š
```javascript
// å„ªå…ˆè¼‰å…¥æœ¬åœ°è…³æœ¬
const localScripts = getLocalScripts();
if (localScripts.length > 0) {
  displayScripts(localScripts);
  return;
}

// é›™é‡å„²å­˜æ©Ÿåˆ¶
if (response.ok) {
  // å¾Œç«¯å„²å­˜æˆåŠŸï¼ŒåŒæ™‚å„²å­˜åˆ°æœ¬åœ°
  saveScriptToLocal(localScriptData);
} else if (response.status === 404) {
  // APIä¸å­˜åœ¨ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜
  saveScriptToLocal(localScriptData);
}
```

**å¾Œç«¯ç‹€æ…‹**ï¼š
- è…³æœ¬å„²å­˜APIå·²å¯¦ç¾ä½†éœ€è¦é‡æ–°éƒ¨ç½²
- è³‡æ–™åº«é€£æ¥å·²å„ªåŒ–ï¼ˆWALæ¨¡å¼ã€é‡è©¦æ©Ÿåˆ¶ï¼‰
- èªè­‰ç³»çµ±éœ€è¦é€²ä¸€æ­¥èª¿è©¦

#### ç•¶å‰ç‹€æ…‹
- âœ… å‰ç«¯è…³æœ¬å„²å­˜åŠŸèƒ½æ­£å¸¸ï¼ˆä½¿ç”¨æœ¬åœ°å‚™æ¡ˆï¼‰
- âœ… è…³æœ¬é¡¯ç¤ºåŠŸèƒ½æ­£å¸¸
- âš ï¸ å¾Œç«¯APIéœ€è¦é‡æ–°éƒ¨ç½²
- âš ï¸ é•·æœŸéœ€è¦è§£æ±ºè³‡æ–™æŒä¹…åŒ–å•é¡Œ

---

## ç‰ˆæ¬Š
2025 AIJobå­¸é™¢ç‰ˆæ¬Šæ‰€æœ‰
